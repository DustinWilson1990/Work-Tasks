<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Work Tasks</title>
<style>
:root{
  --brand:#002D62; --accent:#53A65C;
  --bg:#0e1116; --card:#151a24; --text:#eef2f7; --muted:#a3adbd; --border:#273045;
  --shadow:0 12px 40px rgba(0,0,0,.5);
  --btn:var(--brand); --btn-text:#fff; --pill:#1d2433; --danger:#ff6b6b; --ok:#34d399;
  --tabbg:#0e1116; --tab-border:#1a2131; --vh:100svh;
}
@media (prefers-color-scheme: light){
  :root{ --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#667085; --border:#e6e8ef; --shadow:0 10px 30px rgba(0,0,0,.08); --tabbg:#fff; --tab-border:#e6e8ef; }
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

/* brand header */
.brandBar{position:sticky;top:0;z-index:20;background:linear-gradient(180deg, color-mix(in srgb, var(--brand) 30%, var(--bg)) 0%, var(--bg) 60%);
  border-bottom:2px solid color-mix(in srgb,var(--brand) 40%, var(--border));padding:10px 14px 8px;}
.brandWrap{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:center}
.brandLogo{background:#fff;border:2px solid var(--accent);box-shadow:0 3px 12px rgba(0,0,0,.25);border-radius:12px;padding:8px}
.brandLogo img{display:block;height:56px;width:auto;object-fit:contain}
.topMeta{max-width:1100px;margin:6px auto 0;display:flex;gap:12px;align-items:center;justify-content:space-between;padding:0 14px}
.muted{color:var(--muted);font-size:12px}
.topBtn{font-size:14px;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)}

h3{margin:0 0 10px}
h3::after{content:"";display:block;width:36px;height:3px;background:var(--accent);border-radius:2px;margin-top:6px}

.app{max-width:1100px;margin:0 auto;padding:14px;padding-bottom:120px;min-height:calc(var(--vh) - 50px)}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:14px;margin:12px 0}
.row{display:flex;gap:8px;flex-wrap:wrap}
.row>*{flex:1;min-width:150px}
button,input,select,textarea{font-size:16px;padding:11px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text)}
button{background:var(--btn);color:var(--btn-text);border:none}
button.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
button.danger{background:transparent;border:1px solid var(--danger);color:var(--danger)}
button.ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
button:active{transform:translateY(1px)}
textarea{min-height:84px}
.hint{font-size:12px;color:var(--muted)}
.mini{font-size:12px}
.divider{height:1px;background:var(--border);margin:8px 0}

.tableWrap{overflow-x:auto;border:1px solid var(--border);border-radius:12px}
table{width:100%;border-collapse:collapse}
th,td{text-align:left;border-bottom:1px solid var(--border);padding:10px 8px;vertical-align:top}
th{font-size:12px;text-transform:uppercase;letter-spacing:.02em;color:var(--muted)}
tr:hover td{background:color-mix(in srgb,var(--card) 92%, transparent)}
.pill{font-size:12px;padding:4px 8px;border-radius:999px;background:var(--pill);display:inline-block}
.pill.high{background:color-mix(in srgb,var(--pill) 70%, #f0a000)}
.pill.urgent{background:color-mix(in srgb,var(--pill) 70%, #d33)}
.statusDot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;translate:0 2px}
.st-todo{background:#a0a8b8}.st-inprog{background:#f0a000}.st-done{background:#2ecc71}
.avatars{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.avatar{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:var(--pill);color:var(--text);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover;display:block}

@media (max-width:760px){
  th{display:none}
  table, thead, tbody, tr, td{display:block;width:100%}
  tr{border-bottom:1px solid var(--border)}
  td{border:none;padding:10px 0}
  td[data-label]::before{content:attr(data-label) " ";font-size:12px;color:var(--muted);display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:.02em}
  .tableWrap{border:none}
}

/* tabs */
.tabs{position:fixed;left:0;right:0;bottom:0;z-index:30;background:var(--tabbg);
  border-top:2px solid color-mix(in srgb,var(--brand) 40%, var(--tab-border));
  padding:8px 10px  calc(8px + env(safe-area-inset-bottom));
  display:flex;gap:10px;justify-content:space-around;box-shadow:0 -6px 20px rgba(0,0,0,.15)}
.tabBtn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text);font-size:12px}
.tabBtn.active{background:color-mix(in srgb, var(--accent) 16%, transparent);border-color:var(--accent);color:var(--accent);outline:2px solid color-mix(in srgb,var(--accent) 35%, transparent)}

.toast{position:fixed;bottom:84px;left:50%;transform:translateX(-50%);background:var(--card);color:var(--text);border:1px solid var(--border);box-shadow:var(--shadow);border-radius:12px;padding:10px 14px;z-index:40;display:none}
.toast.show{display:block}
.hidden{display:none!important}
.ok{color:var(--ok)} .dangerText{color:var(--danger)}
.drop{border:2px dashed color-mix(in srgb,var(--brand) 40%, var(--border)); border-radius:12px; padding:16px; text-align:center}
.drop.drag{background:color-mix(in srgb,var(--brand) 10%, transparent)}
</style>
</head>
<body>
  <div class="brandBar">
    <div class="brandWrap"><div class="brandLogo"><img id="logoImg" alt="Alkegen" /></div></div>
    <div class="topMeta"><div id="authStatus" class="muted">Not signed in</div><button id="btnSignOut" class="topBtn hidden">Sign out</button></div>
  </div>

  <div class="app">
    <!-- AUTH -->
    <section id="page-auth" class="page">
      <div class="card">
        <h3>Sign in / Sign up</h3>
        <div class="row"><input id="email" type="email" placeholder="you@example.com" /><input id="password" type="password" placeholder="password (min 6 chars)" /></div>
        <div class="row"><button id="btnSignIn">Sign in</button><button class="secondary" id="btnSignUp">Create account</button></div>
        <p class="hint">Ask an admin to mark you as a moderator if needed.</p>
      </div>
    </section>

    <!-- TASKS -->
    <section id="page-tasks" class="page hidden">
      <div class="card">
        <div class="row">
          <input id="searchInput" placeholder="Search title…" />
          <select id="statusFilter"><option value="all">Status: All</option><option value="open">Status: Open</option><option value="done">Status: Done</option></select>
          <select id="priorityFilter"><option value="all">Priority: All</option><option value="normal">Normal</option><option value="high">High</option><option value="urgent">Urgent</option></select>
          <select id="scopeFilter" class="hidden"><option value="mine">Show: Mine</option><option value="all">Show: All</option></select>
        </div>
      </div>
      <div class="card tableWrap">
        <table>
          <thead><tr><th>Me</th><th>Title</th><th>Priority</th><th>Due</th><th>Assignees</th><th>Done</th><th>Actions</th></tr></thead>
          <tbody id="taskTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- CREATE -->
    <section id="page-create" class="page hidden">
      <div class="card">
        <h3>Create Task</h3>
        <div class="row"><input id="newTitle" placeholder="Task title" /></div>
        <div class="row"><textarea id="newDesc" placeholder="Description (optional)"></textarea></div>
        <div class="row"><select id="newPriority"><option value="normal">Normal</option><option value="high">High</option><option value="urgent">Urgent</option></select><input id="newDue" type="date" /></div>
        <div class="row"><select id="newAssignees" multiple><option value="">Pick assignees…</option></select></div>
        <div class="row"><button id="btnCreate">Create task</button></div>
        <p id="modHint" class="hint hidden dangerText">Only moderators can create tasks.</p>
      </div>

      <!-- Reference Library (editable) -->
      <div class="card">
        <h3>Reference Library</h3>
        <p class="hint">Map each <strong>Ref #</strong> to a task title and optional description (“Focus on …”). These rarely change.</p>
        <div id="refsList"></div>
        <div class="row">
          <input id="refNum" placeholder="Ref #" />
          <input id="refTitle" placeholder="Title (e.g., Maintenance Workshop)" />
          <input id="refDesc" placeholder="Description (optional, e.g., Focus on Permit to Work/Housekeeping)" />
        </div>
        <div class="row"><button id="btnAddRef" class="secondary">Add / Update Ref</button><button id="btnSaveRefs">Save Library</button><button id="btnLoadRefs" class="secondary">Reload</button></div>
        <div id="refsStatus" class="hint"></div>
      </div>

      <!-- CSV importer -->
      <div class="card">
        <h3>Import from Spreadsheet (CSV)</h3>
        <p class="hint">Single CSV export of the sheet. A=Name, C…AG=Days (Ref numbers). We look refs up in the library above.</p>
        <div class="row"><select id="impMonth"><option value="">Month…</option></select><select id="impYear"><option value="">Year…</option></select></div>
        <div class="row"><input id="csvFile" type="file" accept=".csv" /></div>
        <div class="row"><button id="btnParseCsv" class="secondary">Preview tasks</button><button id="btnClearCsv" class="secondary">Clear</button></div>
        <div id="csvInfo" class="hint"></div>
        <div id="csvPreview" class="hidden"><div class="divider"></div><div class="row"><button id="btnCreateCsvTasks">Create all tasks shown</button></div><div id="csvList" class="mini" style="margin-top:8px"></div></div>
      </div>

      <!-- OCR importer (names + numbers only) -->
      <div class="card">
        <h3>Scan Sheet (Photo)</h3>
        <p class="hint">We read only names + small numbers from the left grid. Titles/descriptions come from the Reference Library.</p>
        <div class="row"><input id="sheetImage" type="file" accept="image/*" /></div>
        <div id="dropZone" class="drop mini">Drag & drop an image here</div>
        <div class="row"><select id="ocrMonth"><option value="">Month…</option></select><select id="ocrYear"><option value="">Year…</option></select></div>
        <div id="ocrStatus" class="hint"></div>
        <div class="row"><button id="btnShowOcrText" class="ghost mini">Show OCR text</button></div>
        <pre id="ocrText" class="card mini hidden" style="white-space:pre-wrap;max-height:40vh;overflow:auto"></pre>
        <div id="sheetPreview" class="hidden">
          <div class="divider"></div>
          <div class="row"><button id="btnExtract" class="secondary">Recognize & Preview</button><button id="btnClearPreview" class="secondary">Clear</button></div>
          <div id="previewDiag" class="hint"></div>
          <div id="previewList" class="mini" style="margin-top:8px"></div>
          <div class="row hidden" id="bulkActions"><button id="btnCreateFromPreview">Create selected tasks</button></div>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="page-profile" class="page hidden">
      <div class="card">
        <h3>Your Profile</h3>
        <div class="row"><input id="profName" placeholder="Your name" /><input id="profJob" placeholder="Job title" /></div>
        <input id="profPhoto" placeholder="Photo URL (optional)" />
        <div class="row"><input id="profPhotoFile" type="file" accept="image/*" /><button id="btnUploadPhoto" class="secondary">Upload</button></div>
        <div class="row"><button id="btnSaveProfile">Save Profile</button><button class="secondary" id="btnRefreshProfile">Refresh</button></div>
      </div>
    </section>
  </div>

  <!-- Tabs -->
  <div class="tabs hidden" id="tabs">
    <button class="tabBtn" data-route="#/tasks"><span>🗂️</span><span>Tasks</span></button>
    <button class="tabBtn" data-route="#/create"><span>📄</span><span>Create</span></button>
    <button class="tabBtn" data-route="#/profile"><span>👤</span><span>Profile</span></button>
  </div>

  <div id="toast" class="toast">Saved</div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js" defer></script>

  <script type="module">
    /* Logo */
    const LOGO_URL="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTrdeEzoxxBXtrF9equxIeFP61GsGUqShoIzTWqNmdasXfrYwtDg2Az7Q&s=10";
    document.getElementById('logoImg').src=LOGO_URL;

    /* Firebase */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, updateDoc, addDoc, setDoc, getDoc, serverTimestamp, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBrErkwzc9mucItWzBv5eBupfqRLqS2eDk",
      authDomain: "gemba-bso-walk.firebaseapp.com",
      projectId: "gemba-bso-walk",
      storageBucket: "gemba-bso-walk.firebasestorage.app",
      messagingSenderId: "1032855791471",
      appId: "1:1032855791471:web:1680e88857174c60d26a9a"
    };
    const app=initializeApp(firebaseConfig);
    const auth=getAuth(app);
    const db=getFirestore(app);
    const storage=getStorage(app);

    /* Helpers / state */
    const $=id=>document.getElementById(id);
    const pages={'#/auth':$('page-auth'),'#/tasks':$('page-tasks'),'#/create':$('page-create'),'#/profile':$('page-profile')};
    const tabs=$('tabs'), toast=$('toast');
    function go(route){ if(!currentUser && route!=='#/auth') route='#/auth'; if(currentUser && route==='#/auth') route='#/tasks';
      Object.entries(pages).forEach(([k,v])=>v.classList.toggle('hidden',k!==route)); tabs.classList.toggle('hidden',!currentUser);
      document.querySelectorAll('.tabBtn').forEach(b=>b.classList.toggle('active',b.dataset.route===route)); if(location.hash!==route) location.hash=route; window.scrollTo({top:0});
    }
    window.addEventListener('hashchange',()=>go(location.hash||('#/auth')));
    document.querySelectorAll('.tabBtn').forEach(b=>b.onclick=()=>go(b.dataset.route));
    function toastMsg(m){ toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1200); }

    let currentUser=null, isMod=false, allTasks=[];
    const usersMap=new Map(); let unsubUsers=null, unsubTasks=null;

    async function ensureUserProfile(user){
      const r=doc(db,'users',user.uid), s=await getDoc(r);
      if(!s.exists()) await setDoc(r,{uid:user.uid,email:user.email||'',name:'',jobTitle:'',photoURL:'',createdAt:serverTimestamp()});
    }
    async function isModerator(uid){ const s=await getDoc(doc(db,'moderators',uid)); return s.exists(); }

    // ------- Reference Library -------
    // Defaults (fill more when you have time). Mods can edit in UI and save to Firestore.
    let refLib = {
      "1": {title:"Maintenance Workshop", desc:"Focus: Permit to Work / Housekeeping"},
      "2": {title:"Burner Rm 1-12", desc:"Focus: PPE / Recent LFI / Housekeeping"},
      "3": {title:"Burner Rm 13-22", desc:"Focus: PPE / Recent LFI / Housekeeping"},
      "4": {title:"Collectors 1-12", desc:"Focus: Hand Safety / LOTO / PPE"},
      "5": {title:"Collectors 13-22", desc:"Focus: Hand Safety / LOTO / PPE"},
      "6": {title:"Quality Lab", desc:"Focus: PPE / Recent LFI"},
      "7": {title:"Warehouse", desc:"Focus: Recent LFI / Housekeeping"},
      "8": {title:"Compactor Area", desc:"Focus: Housekeeping / Contractor Mgmt"},
      "9": {title:"Drum Filters/Baghouses", desc:"Focus: Permit to Work / LOTO"},
      "10": {title:"Engineering Stores - Upstairs Mezz", desc:"Focus: Housekeeping"},
      "11": {title:"Offices", desc:"Focus: Housekeeping"},
      "12": {title:"Maintenance Team Member", desc:"Focus: Machine Guarding / Permit to Work"},
      "13": {title:"Contractors", desc:"Focus: Contractor Mgmt / Permit to Work"}
    };
    const REFS_DOC = doc(db,'config','refsLib');

    async function loadRefs(){
      try{ const s=await getDoc(REFS_DOC); if(s.exists()) refLib = s.data().refs || refLib; renderRefs(); $('refsStatus').textContent='Loaded from cloud.'; }
      catch{ renderRefs(); $('refsStatus').textContent='Using local defaults.'; }
    }
    async function saveRefs(){
      if(!isMod) return alert('Only moderators can save the library.');
      await setDoc(REFS_DOC,{refs:refLib,updatedAt:serverTimestamp()});
      $('refsStatus').textContent='Saved.'; toastMsg('Reference library saved');
    }
    function renderRefs(){
      const wrap=$('refsList'); wrap.innerHTML='';
      const keys=Object.keys(refLib).sort((a,b)=>parseInt(a)-parseInt(b));
      keys.forEach(k=>{
        const row=document.createElement('div'); row.className='card mini';
        row.innerHTML=`<strong>Ref ${k}</strong>: ${refLib[k].title} <span class="muted">— ${refLib[k].desc||''}</span>`;
        wrap.appendChild(row);
      });
    }
    $('btnAddRef').onclick=()=>{ const n=$('refNum').value.trim(); const t=$('refTitle').value.trim(); const d=$('refDesc').value.trim();
      if(!n||!t) return alert('Ref # and Title required'); refLib[n]={title:t,desc:d}; renderRefs(); $('refNum').value=$('refTitle').value=$('refDesc').value=''; };
    $('btnSaveRefs').onclick=saveRefs; $('btnLoadRefs').onclick=loadRefs;

    // ------- Users & tasks -------
    function fillAssigneeSelect(sel){
      sel.innerHTML='';
      for (const [uid,u] of Array.from(usersMap.entries()).sort((a,b)=>(a[1].email||'').localeCompare(b[1].email||''))){
        const o=document.createElement('option'); o.value=uid; const nm=u.name?.trim()||'(no name)'; o.textContent=`${nm}${u.email?' ('+u.email+')':''}`; sel.appendChild(o);
      }
    }
    function nameToUid(name){
      const target=(name||'').toLowerCase().trim().replace(/\s+\(.*?\)\s*$/,'');
      for(const [uid,u] of usersMap.entries()){
        const nm=(u.name||'').toLowerCase().trim();
        if(!nm) continue;
        if(nm===target) return uid;
        if(nm.includes(target) || target.includes(nm)) return uid;
      }
      return null;
    }
    function endOfMonth(y,m){ return new Date(y, m, 0); }
    function priorityFromDaysLeft(x){ if(x<=10) return 'urgent'; if(x<=20) return 'high'; return 'normal'; }
    function deriveStatus(t){ const a=(t.assignees||[]).length, c=(t.completedBy||[]).length; if(a===0||c===0) return 'todo'; if(c<a) return 'in_progress'; return 'done'; }

    async function watchUsers(){
      if (unsubUsers){unsubUsers();unsubUsers=null;}
      const qUsers=query(collection(db,'users'),orderBy('email'));
      unsubUsers=onSnapshot(qUsers,(snap)=>{
        usersMap.clear();
        snap.forEach(d=>{const u=d.data(); usersMap.set(u.uid,{name:u.name||'',email:u.email||'',photoURL:u.photoURL||''});});
        fillAssigneeSelect($('newAssignees'));
        renderTasks();
      });
    }
    async function watchTasks(){
      if (unsubTasks){unsubTasks();unsubTasks=null;}
      const qy=(isMod&&$('scopeFilter').value==='all')?query(collection(db,'tasks'),orderBy('createdAt','desc')):query(collection(db,'tasks'),where('assignees','array-contains',currentUser.uid),orderBy('createdAt','desc'));
      unsubTasks=onSnapshot(qy,(snap)=>{ allTasks=snap.docs.map(d=>({id:d.id,...d.data()})); renderTasks(); });
    }

    function applyFilters(items){
      const q=($('searchInput').value||'').toLowerCase(), fStatus=$('statusFilter').value, fPrio=$('priorityFilter').value, scope=isMod?$('scopeFilter').value:'mine';
      let arr=items.slice();
      if(scope==='mine'&&currentUser) arr=arr.filter(t=>(t.assignees||[]).includes(currentUser.uid));
      if(q) arr=arr.filter(t=>(t.title||'').toLowerCase().includes(q));
      if(fPrio!=='all') arr=arr.filter(t=>(t.priority||'normal')===fPrio);
      if(fStatus!=='all') arr=arr.filter(t=>{const st=deriveStatus(t); return fStatus==='done'?st==='done':(st==='todo'||st==='in_progress');});
      const rank={urgent:0,high:1,normal:2};
      arr.sort((a,b)=>{const pa=rank[a.priority||'normal']??2, pb=rank[b.priority||'normal']??2; if(pa!==pb) return pa-pb;
        const da=a.dueDate||'', db=b.dueDate||''; if(da!==db) return (da||'9999-99-99').localeCompare(db||'9999-99-99'); return (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0);});
      return arr;
    }

    function renderTasks(){
      const tbody=$('taskTbody'); tbody.innerHTML='';
      const rows=applyFilters(allTasks);
      rows.forEach(row=>{
        const tr=document.createElement('tr');

        const tdMe=document.createElement('td'); tdMe.setAttribute('data-label','Me');
        const amAssigned=(row.assignees||[]).includes(currentUser?.uid); const iAmDone=(row.completedBy||[]).includes(currentUser?.uid);
        const meCb=document.createElement('input'); meCb.type='checkbox'; meCb.checked=!!iAmDone; meCb.disabled=!amAssigned;
        meCb.onchange=async()=>{try{const ref=doc(db,'tasks',row.id); if(meCb.checked) await updateDoc(ref,{completedBy:arrayUnion(currentUser.uid),updatedAt:serverTimestamp()}); else await updateDoc(ref,{completedBy:arrayRemove(currentUser.uid),updatedAt:serverTimestamp()}); toastMsg('Updated'); }catch(e){ alert('Update failed: '+e.message); meCb.checked=!meCb.checked; }};
        tdMe.appendChild(meCb);

        const tdTitle=document.createElement('td'); tdTitle.setAttribute('data-label','Title');
        const dot=document.createElement('span'); const st=deriveStatus(row);
        dot.className='statusDot '+(st==='done'?'st-done':st==='in_progress'?'st-inprog':'st-todo');
        const ttl=document.createElement('span'); ttl.innerHTML=`<strong>${row.title||'(no title)'}</strong><br><span class="muted">${row.description||''}</span>`;
        tdTitle.appendChild(dot); tdTitle.appendChild(ttl);

        const tdPr=document.createElement('td'); tdPr.setAttribute('data-label','Priority');
        const pill=document.createElement('span'); const pr=(row.priority||'normal'); pill.className='pill '+(pr==='urgent'?'urgent':pr==='high'?'high':''); pill.textContent=pr.toUpperCase(); tdPr.appendChild(pill);

        const tdDue=document.createElement('td'); tdDue.setAttribute('data-label','Due'); tdDue.textContent=row.dueDate||'';

        const tdAs=document.createElement('td'); tdAs.setAttribute('data-label','Assignees');
        const avs=document.createElement('div'); avs.className='avatars'; (row.assignees||[]).forEach(uid=>avs.appendChild((()=>{const el=document.createElement('div'); el.className='avatar'; const u=usersMap.get(uid)||{}; el.textContent=(u.name||u.email||'?').charAt(0).toUpperCase(); return el;})())); tdAs.appendChild(avs);

        const tdDone=document.createElement('td'); tdDone.setAttribute('data-label','Done'); tdDone.textContent=`${(row.completedBy||[]).length}/${(row.assignees||[]).length}`;

        const tdAct=document.createElement('td'); tdAct.setAttribute('data-label','Actions');
        const bEdit=document.createElement('button'); bEdit.className='secondary'; bEdit.textContent='Edit';
        const bDel=document.createElement('button'); bDel.className='danger'; bDel.textContent='Delete';
        if(!isMod){ bEdit.disabled=true; bDel.disabled=true; }
        tdAct.appendChild(bEdit); tdAct.appendChild(bDel);

        // inline editor
        const trEdit=document.createElement('tr'); const tdEdit=document.createElement('td'); tdEdit.colSpan=7; trEdit.appendChild(tdEdit); trEdit.className='hidden';
        const panel=document.createElement('div'); panel.className='card';
        panel.innerHTML=`
          <div class="row"><input id="eTitle" value="${row.title||''}" placeholder="Title"></div>
          <div class="row"><textarea id="eDesc" placeholder="Description">${row.description||''}</textarea></div>
          <div class="row">
            <select id="ePrio">
              <option value="normal"${(row.priority||'normal')==='normal'?' selected':''}>Normal</option>
              <option value="high"${row.priority==='high'?' selected':''}>High</option>
              <option value="urgent"${row.priority==='urgent'?' selected':''}>Urgent</option>
            </select>
            <input id="eDue" type="date" value="${row.dueDate||''}">
          </div>
          <div class="row"><select id="eAss" multiple></select></div>
          <div class="row"><button id="eSave">Save</button><button id="eCancel" class="secondary">Cancel</button></div>`;
        tdEdit.appendChild(panel);

        function openEditor(){
          if(!isMod) return;
          trEdit.classList.remove('hidden');
          const sel=panel.querySelector('#eAss'); sel.innerHTML='';
          for (const [uid,u] of Array.from(usersMap.entries()).sort((a,b)=>(a[1].email||'').localeCompare(b[1].email||''))){
            const o=document.createElement('option'); o.value=uid; const nm=u.name?.trim()||'(no name)'; o.textContent=`${nm}${u.email?' ('+u.email+')':''}`; if((row.assignees||[]).includes(uid)) o.selected=true; sel.appendChild(o);
          }
          trEdit.scrollIntoView({behavior:'smooth', block:'center'});
        }
        bEdit.onclick=openEditor;
        panel.querySelector('#eCancel').onclick=()=> trEdit.classList.add('hidden');
        panel.querySelector('#eSave').onclick=async()=>{ try{
          const ref=doc(db,'tasks',row.id);
          const eTitle=panel.querySelector('#eTitle').value.trim()||'(no title)';
          const eDesc=panel.querySelector('#eDesc').value.trim();
          const ePrio=panel.querySelector('#ePrio').value;
          const eDue=panel.querySelector('#eDue').value||null;
          const newAssignees=Array.from(panel.querySelector('#eAss').selectedOptions).map(o=>o.value);
          await updateDoc(ref,{title:eTitle,description:eDesc,priority:ePrio,dueDate:eDue,assignees:newAssignees,updatedAt:serverTimestamp()});
          trEdit.classList.add('hidden'); toastMsg('Task updated');
        }catch(e){ alert('Save failed: '+e.message); }};

        bDel.onclick=async()=>{ if(!isMod) return;
          if(!confirm('Delete this task?')) return;
          try{ await deleteDoc(doc(db,'tasks',row.id)); toastMsg('Task deleted'); }catch(e){ alert('Delete failed: '+e.message); }
        };

        tr.appendChild(tdMe); tr.appendChild(tdTitle); tr.appendChild(tdPr); tr.appendChild(tdDue); tr.appendChild(tdAs); tr.appendChild(tdDone); tr.appendChild(tdAct);
        tbody.appendChild(tr); tbody.appendChild(trEdit);
      });
    }

    // create single task
    $('btnCreate').onclick=async()=>{
      if(!isMod) return alert('Only moderators can create.');
      const title=$('newTitle').value.trim(); if(!title) return alert('Enter a title');
      const desc=$('newDesc').value.trim(); const prio=$('newPriority').value||'normal'; const due=$('newDue').value||null;
      const ass=Array.from($('newAssignees').selectedOptions).map(o=>o.value);
      const assignees=ass.length?ass:[currentUser.uid];
      await addDoc(collection(db,'tasks'),{title,description:desc,priority:prio,dueDate:due,assignees,completedBy:[],createdBy:currentUser.uid,createdAt:serverTimestamp(),updatedAt:serverTimestamp()});
      $('newTitle').value=''; $('newDesc').value=''; $('newPriority').value='normal'; $('newDue').value=''; for(const o of $('newAssignees').options)o.selected=false;
      toastMsg('Task created');
    };

    // Month/Year selects
    function fillMonthYear(selM, selY){
      selM.innerHTML='<option value="">Month…</option>';
      "Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(' ').forEach((m,i)=>{const o=document.createElement('option');o.value=i+1;o.textContent=m;selM.appendChild(o);});
      selY.innerHTML='<option value="">Year…</option>';
      const y0=new Date().getFullYear(); for(let y=y0-1;y<=y0+2;y++){const o=document.createElement('option');o.value=y;o.textContent=y;selY.appendChild(o);}
    }
    fillMonthYear($('impMonth'),$('impYear')); fillMonthYear($('ocrMonth'),$('ocrYear'));

    // CSV (name + day refs only)
    function parseCsvRaw(file){ return new Promise((resolve,reject)=> Papa.parse(file,{header:false,skipEmptyLines:true,complete:res=>resolve(res.data),error:reject})); }
    function buildTasksFromCsv(rows, year, month){
      const COL_NAME=0, COL_DAY_START=2, COL_DAY_END=32;
      const last=endOfMonth(year, month); const dueStr=last.toISOString().slice(0,10);
      const daysLeft=Math.ceil((last - new Date())/86400000); const basePriority=priorityFromDaysLeft(daysLeft);
      const tasks=[];
      for(const r of rows){
        const name=r[COL_NAME]; if(!name) continue;
        const assUid=nameToUid(String(name));
        for(let d=1; d<=31; d++){
          const col=COL_DAY_START+(d-1); const v=r[col]; if(!v) continue;
          const ref=String(parseInt(v,10)); if(!refLib[ref]) continue; // unknown ref, skip
          const {title,desc}=refLib[ref];
          tasks.push({title, description:desc, dueDate:dueStr, priority:basePriority, ref, scheduledDay:d, assignees:assUid?[assUid]:[], unresolvedAssignee:assUid?null:String(name)});
        }
      }
      return tasks;
    }
    $('btnClearCsv').onclick=()=>{ $('csvFile').value=''; $('csvList').innerHTML=''; $('csvPreview').classList.add('hidden'); $('csvInfo').textContent=''; };
    $('btnParseCsv').onclick=async()=>{
      if(!isMod) return alert('Only moderators can import.');
      const m=parseInt($('impMonth').value,10), y=parseInt($('impYear').value,10);
      if(!m||!y) return alert('Pick Month & Year');
      const f=$('csvFile').files?.[0]; if(!f) return alert('Select CSV');
      $('csvInfo').textContent='Parsing…';
      try{
        const rows=await parseCsvRaw(f);
        const tasks=buildTasksFromCsv(rows,y,m);
        if(!tasks.length){ $('csvInfo').innerHTML='<span class="dangerText">No tasks found.</span>'; return; }
        $('csvInfo').innerHTML=`<span class="ok">Previewing ${tasks.length} task(s).</span>`;
        const list=$('csvList'); list.innerHTML='';
        tasks.forEach(t=>{ const d=document.createElement('div'); d.className='card mini'; d.innerHTML=`<div><strong>${t.title}</strong> — ${t.description||''}</div><div>Ref ${t.ref}, Day ${t.scheduledDay}, Due ${t.dueDate}, Priority ${t.priority}</div><div>${t.assignees.length?'✔ matched user':('<span class="dangerText">⚠ not matched: '+t.unresolvedAssignee+'</span>')}</div>`; list.appendChild(d); });
        $('csvPreview').classList.remove('hidden');
        $('btnCreateCsvTasks').dataset.payload=JSON.stringify(tasks);
      }catch(e){ $('csvInfo').innerHTML=`<span class="dangerText">Parse failed: ${e.message}</span>`; }
    };
    $('btnCreateCsvTasks').onclick=async()=>{
      const raw=$('btnCreateCsvTasks').dataset.payload; if(!raw) return;
      const tasks=JSON.parse(raw); let created=0;
      for(const t of tasks){
        const ass=t.assignees.length?t.assignees:[currentUser.uid];
        await addDoc(collection(db,'tasks'),{title:t.title,description:t.description,priority:t.priority,dueDate:t.dueDate,assignees:ass,completedBy:[],ref:t.ref,scheduledDay:t.scheduledDay,createdBy:currentUser.uid,createdAt:serverTimestamp(),updatedAt:serverTimestamp()});
        created++;
      }
      toastMsg(`Created ${created} task(s)`); $('btnClearCsv').click();
    };

    // --------- OCR (names + numbers only) ----------
    let ocrImageBlob=null;
    $('sheetImage').onchange=()=>{const f=$('sheetImage').files?.[0]; if(!f) return; ocrImageBlob=f; $('sheetPreview').classList.remove('hidden'); $('ocrStatus').textContent=`Selected: ${f.name}`; $('previewList').innerHTML=''; $('bulkActions').classList.add('hidden');};
    ;['dragenter','dragover'].forEach(evt=>$('dropZone').addEventListener(evt,e=>{e.preventDefault(); $('dropZone').classList.add('drag');}));
    ;['dragleave','drop'].forEach(evt=>$('dropZone').addEventListener(evt,e=>{e.preventDefault(); $('dropZone').classList.remove('drag');}));
    $('dropZone').addEventListener('drop',(e)=>{const f=e.dataTransfer.files?.[0]; if(f && f.type.startsWith('image/')){ ocrImageBlob=f; $('sheetPreview').classList.remove('hidden'); $('ocrStatus').textContent=`Selected: ${f.name}`; $('previewList').innerHTML=''; $('bulkActions').classList.add('hidden'); }});
    $('btnShowOcrText').onclick=()=>$('ocrText').classList.toggle('hidden');
    $('btnClearPreview').onclick=()=>{ $('sheetImage').value=''; ocrImageBlob=null; $('sheetPreview').classList.add('hidden'); $('ocrStatus').textContent=''; $('previewList').innerHTML=''; $('bulkActions').classList.add('hidden'); $('ocrText').textContent=''; $('previewDiag').textContent=''; };

    function normalize(s){ return s.replace(/[–—]/g,'-'); }
    function parseNamesAndRefs(text){
      const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const assignments=[];
      for(const ln of lines){
        // “Name ... numbers”
        const m=ln.match(/^([A-Za-z][A-Za-z .()'-]+?)\s+(.+)$/);
        if(!m) continue;
        const name=m[1].trim();
        const nums=(m[2].match(/\b(\d{1,2})\b/g)||[]).map(n=>String(parseInt(n,10)));
        if(nums.length) assignments.push({name, refs:nums});
      }
      return {assignments, lineCount:lines.length};
    }

    $('btnExtract').onclick=async()=>{
      if(!isMod) return alert('Only moderators can use Scan Sheet.');
      if(!ocrImageBlob) return alert('Choose an image first.');
      const m=parseInt($('ocrMonth').value,10), y=parseInt($('ocrYear').value,10); if(!m||!y) return alert('Pick Month & Year');
      $('ocrStatus').textContent='Reading image…';
      try{
        const {data}=await Tesseract.recognize(ocrImageBlob,'eng',{logger:p=>{$('ocrStatus').textContent = p.status ? `${p.status} ${p.progress?Math.round(p.progress*100)+'%':''}`:'Reading image…';}});
        const raw=normalize(data.text||''); $('ocrText').textContent=raw;
        const {assignments,lineCount}=parseNamesAndRefs(raw);
        const last=endOfMonth(y,m), dueStr=last.toISOString().slice(0,10), daysLeft=Math.ceil((last - new Date())/86400000), basePriority=priorityFromDaysLeft(daysLeft);

        const tasks=[];
        for(const a of assignments){
          const uid=nameToUid(a.name);
          let dayIdx=1;
          for(const ref of a.refs){
            if(!refLib[ref]) continue; // unknown ref, skip
            const {title,desc}=refLib[ref];
            tasks.push({title, description:desc, dueDate:dueStr, priority:basePriority, ref, scheduledDay:dayIdx++, assignees:uid?[uid]:[], unresolvedAssignee:uid?null:a.name});
          }
        }

        $('previewDiag').textContent=`Lines:${lineCount}  refs-known:${Object.keys(refLib).length}  people:${assignments.length}`;
        if(!tasks.length){ $('ocrStatus').innerHTML='<span class="dangerText">No tasks parsed. Ensure the left grid is sharp and close, or use CSV.</span>'; return; }
        $('ocrStatus').innerHTML=`<span class="ok">Parsed ${tasks.length} candidate task(s).</span>`;

        const list=$('previewList'); list.innerHTML='';
        tasks.forEach((t,i)=>{ const d=document.createElement('div'); d.className='card mini';
          d.innerHTML=`<label class="mini"><input type="checkbox" class="pv-check" data-i="${i}" checked> Create</label>
          <div><strong>${t.title}</strong> — ${t.description||''}</div>
          <div>Ref ${t.ref}, Day ${t.scheduledDay}, Due ${t.dueDate}, Priority ${t.priority}</div>
          <div>${t.assignees.length?'✔ matched user':('<span class="dangerText">⚠ not matched: '+t.unresolvedAssignee+'</span>')}</div>`;
          list.appendChild(d);
        });
        $('bulkActions').classList.remove('hidden');

        $('btnCreateFromPreview').onclick=async()=>{
          let created=0;
          const checks=document.querySelectorAll('.pv-check');
          for(const chk of checks){
            if(!chk.checked) continue;
            const i=parseInt(chk.dataset.i,10); const t=tasks[i];
            const ass=t.assignees.length?t.assignees:[currentUser.uid];
            await addDoc(collection(db,'tasks'),{title:t.title,description:t.description,priority:t.priority,dueDate:t.dueDate,assignees:ass,completedBy:[],ref:t.ref,scheduledDay:t.scheduledDay,createdBy:currentUser.uid,createdAt:serverTimestamp(),updatedAt:serverTimestamp()});
            created++;
          }
          toastMsg(`Created ${created} task(s)`); $('btnClearPreview').click();
        };
      }catch(e){ $('ocrStatus').innerHTML=`<span class="dangerText">OCR failed: ${e.message}</span>`; }
    };

    // profile
    $('btnSaveProfile').onclick=async()=>{ if(!currentUser) return; await setDoc(doc(db,'users',currentUser.uid),{name:$('profName').value.trim(),jobTitle:$('profJob').value.trim(),photoURL:$('profPhoto').value.trim(),updatedAt:serverTimestamp()},{merge:true}); toastMsg('Profile saved'); };
    $('btnRefreshProfile').onclick=async()=>{ if(!currentUser) return; const s=await getDoc(doc(db,'users',currentUser.uid)); if(s.exists()){const u=s.data();$('profName').value=u.name||'';$('profJob').value=u.jobTitle||'';$('profPhoto').value=u.photoURL||'';} };
    $('btnUploadPhoto').onclick=async()=>{ if(!currentUser) return alert('Sign in first.'); const f=$('profPhotoFile').files?.[0]; if(!f) return alert('Pick an image'); const ext=(f.name.split('.').pop()||'jpg').toLowerCase(); const r=sRef(storage,`profilePhotos/${currentUser.uid}.${ext}`); await uploadBytes(r,f); const url=await getDownloadURL(r); $('profPhoto').value=url; await setDoc(doc(db,'users',currentUser.uid),{photoURL:url},{merge:true}); toastMsg('Photo uploaded'); };

    // filters
    ['searchInput','statusFilter','priorityFilter'].forEach(id=>$(id).addEventListener('input',renderTasks));
    $('scopeFilter').addEventListener('change',watchTasks);

    // auth
    $('btnSignIn').onclick=async()=>{ try{ await signInWithEmailAndPassword(auth,$('email').value,$('password').value);}catch(e){ alert(e.message); } };
    $('btnSignUp').onclick=async()=>{ try{ await createUserWithEmailAndPassword(auth,$('email').value,$('password').value);}catch(e){ alert(e.message); } };
    $('btnSignOut').onclick=async()=>{ await signOut(auth); };

    async function startData(){ await loadRefs(); await watchUsers(); $('scopeFilter').classList.toggle('hidden',!isMod); $('scopeFilter').value='mine'; await watchTasks(); }

    onAuthStateChanged(auth, async (user)=>{
      currentUser=user||null;
      if(user){
        $('btnSignOut').classList.remove('hidden');
        $('authStatus').textContent='Signed in';
        await ensureUserProfile(user);
        isMod = await isModerator(user.uid);
        $('modHint').classList.toggle('hidden', isMod);
        startData(); go('#/tasks');
      }else{
        $('btnSignOut').classList.add('hidden');
        $('authStatus').textContent='Not signed in';
        if (unsubTasks){unsubTasks();unsubTasks=null;} if (unsubUsers){unsubUsers();unsubUsers=null;}
        allTasks=[]; $('taskTbody').innerHTML=''; go('#/auth');
      }
    });

    window.addEventListener('load',()=>go(location.hash||'#/auth'));
  </script>
</body>
</html>