<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Work Tasks</title>
  <style>
    :root{
      --bg:#0e1116; --card:#151a24; --text:#eef2f7; --muted:#a3adbd; --border:#273045;
      --shadow:0 12px 40px rgba(0,0,0,.5); --brand:#5aa9ff; --btn:#1f6feb; --btn-text:#fff;
      --pill:#1d2433; --danger:#ff6b6b; --ok:#34d399; --tabbg:#0e1116; --tab-border:#1a2131; --vh:100svh;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#667085; --border:#e6e8ef; --shadow:0 10px 30px rgba(0,0,0,.08); --tabbg:#fff; --tab-border:#e6e8ef; }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    /* Top bar (compact) */
    .navTop{position:sticky;top:0;z-index:20;backdrop-filter:blur(6px);
      background:linear-gradient(to bottom,color-mix(in srgb,var(--bg) 92%,transparent),transparent);
      border-bottom:1px solid var(--border)}
    .navTopInner{max-width:1100px;margin:0 auto;padding:8px 14px;display:flex;align-items:center;gap:10px}
    .brand{display:flex;align-items:center;gap:8px;font-weight:700}
    .logo{width:22px;height:22px;border-radius:6px;background:var(--brand);display:inline-block}
    .brandText{font-size:14px}
    .grow{flex:1}
    .muted{color:var(--muted);font-size:12px}
    .topBtn{font-size:14px;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)}

    /* App area */
    .app{max-width:1100px;margin:0 auto;padding:14px;padding-bottom:120px;min-height:calc(var(--vh) - 50px)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:14px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row>*{flex:1;min-width:150px}
    button,input,select,textarea{font-size:16px;padding:11px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text)}
    button{background:var(--btn);color:var(--btn-text);border:none}
    button.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
    textarea{min-height:84px}

    /* Filters */
    .filtersHeader{display:flex;align-items:center;justify-content:space-between}
    .filtersBody{display:none; margin-top:8px}
    .filters.open .filtersBody{display:block}
    .hint{font-size:12px;color:var(--muted)}
    .mini{font-size:12px}
    .divider{height:1px;background:var(--border);margin:8px 0}

    /* Table / cards */
    .tableWrap{overflow-x:auto;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{text-align:left;border-bottom:1px solid var(--border);padding:10px 8px;vertical-align:top}
    th{font-size:12px;text-transform:uppercase;letter-spacing:.02em;color:var(--muted)}
    tr:hover td{background:color-mix(in srgb,var(--card) 92%, transparent)}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:var(--pill);display:inline-block}
    .pill.high{background:color-mix(in srgb,var(--pill) 70%, #f0a000)}
    .pill.urgent{background:color-mix(in srgb,var(--pill) 70%, #d33)}
    .statusDot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;translate:0 2px}
    .st-todo{background:#a0a8b8}.st-inprog{background:#f0a000}.st-done{background:#2ecc71}
    .avatars{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .avatar{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:var(--pill);color:var(--text);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .avatar.more{background:transparent;border:none;font-weight:600}

    @media (max-width: 760px){
      th{display:none}
      table, thead, tbody, tr, td{display:block;width:100%}
      tr{border-bottom:1px solid var(--border)}
      td{border:none;padding:10px 0}
      td[data-label]::before{content:attr(data-label) " ";font-size:12px;color:var(--muted);display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:.02em}
      .tableWrap{border:none}
      .brandText{display:none}
    }

    /* Tabs (sticky) */
    .tabs{position:fixed;left:0;right:0;bottom:0;z-index:30;background:var(--tabbg);
      border-top:1px solid var(--tab-border);padding:8px 10px  calc(8px + env(safe-area-inset-bottom));
      display:flex;gap:10px;justify-content:space-around;box-shadow:0 -6px 20px rgba(0,0,0,.15)}
    .tabBtn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px;border-radius:12px;border:1px solid var(--border);
      background:transparent;color:var(--text);font-size:12px}
    .tabBtn.active{background:color-mix(in srgb,var(--card) 85%, transparent)}
    .tabIcon{font-size:18px}

    .toast{position:fixed;bottom:84px;left:50%;transform:translateX(-50%);background:var(--card);color:var(--text);border:1px solid var(--border);box-shadow:var(--shadow);border-radius:12px;padding:10px 14px;z-index:40;display:none}
    .toast.show{display:block}
    #debug{position:fixed;bottom:140px;left:8px;right:8px;background:#000a;color:#fff;padding:8px;border-radius:8px;font:12px monospace;z-index:50;display:none;max-height:40vh;overflow:auto}
    .hidden{display:none!important}
    .ok{color:var(--ok)} .danger{color:var(--danger)}
  </style>
</head>
<body>
  <!-- Top bar -->
  <div class="navTop">
    <div class="navTopInner">
      <div class="brand"><span class="logo"></span><span class="brandText">Work Tasks</span></div>
      <div id="authStatus" class="muted">Not signed in</div>
      <div class="grow"></div>
      <button id="btnSignOut" class="topBtn hidden">Sign out</button>
    </div>
  </div>

  <div class="app">
    <!-- Auth -->
    <section id="page-auth" class="page">
      <div class="card">
        <h3>Sign in / Sign up</h3>
        <div class="row">
          <input id="email" type="email" placeholder="you@example.com" />
          <input id="password" type="password" placeholder="password (min 6 chars)" />
        </div>
        <div class="row">
          <button id="btnSignIn">Sign in</button>
          <button class="secondary" id="btnSignUp">Create account</button>
        </div>
        <p class="hint">Ask an admin to mark you as a moderator if needed.</p>
      </div>
    </section>

    <!-- Tasks -->
    <section id="page-tasks" class="page hidden">
      <div class="card" id="filtersCard">
        <div class="filtersHeader">
          <strong>Filters</strong>
          <button id="btnToggleFilters" class="secondary mini">Show</button>
        </div>
        <div class="filtersBody" id="filtersBody">
          <div class="row">
            <input id="searchInput" placeholder="Search title‚Ä¶" />
            <select id="statusFilter">
              <option value="all">Status: All</option>
              <option value="open">Status: Open</option>
              <option value="done">Status: Done</option>
            </select>
            <select id="priorityFilter">
              <option value="all">Priority: All</option>
              <option value="normal">Normal</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
            <select id="scopeFilter" class="hidden">
              <option value="mine">Show: Mine</option>
              <option value="all">Show: All</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card tableWrap">
        <table>
          <thead>
            <tr>
              <th>Me</th><th>Title</th><th>Priority</th><th>Due</th><th>Assignees</th><th>Done</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="taskTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Create -->
    <section id="page-create" class="page hidden">
      <div class="card">
        <h3>Create Task</h3>
        <div class="row"><input id="newTitle" placeholder="Task title" /></div>
        <div class="row"><textarea id="newDesc" placeholder="Description (optional)"></textarea></div>
        <div class="row">
          <select id="newPriority">
            <option value="normal">Normal</option>
            <option value="high">High</option>
            <option value="urgent">Urgent</option>
          </select>
          <input id="newDue" type="date" />
        </div>
        <div class="row">
          <select id="newAssignees" multiple><option value="">Pick assignees‚Ä¶</option></select>
        </div>
        <div class="row"><button id="btnCreate">Create task</button></div>
        <p id="modHint" class="hint hidden danger">Only moderators can create tasks.</p>
      </div>

      <!-- NEW: Spreadsheet importer -->
      <div class="card">
        <h3>Import from Spreadsheet (CSV) ‚Äî Recommended</h3>
        <p class="hint">Upload 2 CSVs: <strong>Schedule</strong> (Name, Count, 1..31 with Ref codes) and <strong>Task Library</strong> (Ref, Area, Focus). Then pick Month+Year and create tasks.</p>
        <div class="row">
          <select id="impMonth">
            <option value="">Month‚Ä¶</option>
          </select>
          <select id="impYear">
            <option value="">Year‚Ä¶</option>
          </select>
        </div>
        <div class="row">
          <input id="csvSchedule" type="file" accept=".csv" />
          <input id="csvLibrary"  type="file" accept=".csv" />
        </div>
        <div class="row">
          <button id="btnParseCsv" class="secondary">Preview tasks</button>
          <button id="btnClearCsv" class="secondary">Clear</button>
        </div>
        <div id="csvInfo" class="hint"></div>
        <div id="csvPreview" class="hidden">
          <div class="divider"></div>
          <div class="row">
            <button id="btnCreateCsvTasks">Create all tasks shown</button>
          </div>
          <div id="csvList" class="mini" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- OCR fallback (kept) -->
      <div class="card">
        <h3>Scan Sheet (Beta) ‚Äî Camera OCR</h3>
        <p class="hint">Less accurate. CSV is preferred.</p>
        <div class="row"><input id="sheetImage" type="file" accept="image/*" capture="environment" /></div>
        <div id="ocrStatus" class="hint"></div>
        <div id="sheetPreview" class="hidden">
          <div class="divider"></div>
          <div class="row">
            <button id="btnExtract" class="secondary">Extract text</button>
            <button id="btnClearPreview" class="secondary">Clear</button>
          </div>
          <div id="previewList" class="mini" style="margin-top:8px"></div>
          <div class="row hidden" id="bulkActions">
            <button id="btnCreateFromPreview">Create selected tasks</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Profile -->
    <section id="page-profile" class="page hidden">
      <div class="card">
        <h3>Your Profile</h3>
        <div class="row">
          <input id="profName" placeholder="Your name" />
          <input id="profJob" placeholder="Job title (e.g., Supervisor)" />
        </div>
        <input id="profPhoto" placeholder="Photo URL (optional)" />
        <div class="row">
          <button id="btnSaveProfile">Save Profile</button>
          <button class="secondary" id="btnRefreshProfile">Refresh</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Tabs -->
  <div class="tabs hidden" id="tabs">
    <button class="tabBtn" data-route="#/tasks"><span class="tabIcon">üóÇÔ∏è</span><span>Tasks</span></button>
    <button class="tabBtn" data-route="#/create"><span class="tabIcon">üìÑ</span><span>Create</span></button>
    <button class="tabBtn" data-route="#/profile"><span class="tabIcon">üë§</span><span>Profile</span></button>
  </div>

  <div id="toast" class="toast">Saved</div>
  <div id="debug"></div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js" defer></script>

  <script type="module">
    /* ===== Firebase ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, updateDoc, addDoc, serverTimestamp, getDoc, setDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBrErkwzc9mucItWzBv5eBupfqRLqS2eDk",
      authDomain: "gemba-bso-walk.firebaseapp.com",
      projectId: "gemba-bso-walk",
      storageBucket: "gemba-bso-walk.firebasestorage.app",
      messagingSenderId: "1032855791471",
      appId: "1:1032855791471:web:1680e88857174c60d26a9a"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ===== Utilities & UI ===== */
    const $ = (id)=>document.getElementById(id);
    const toast = $('toast'), debugBox = $('debug');
    const pages={'#/auth':$('page-auth'),'#/tasks':$('page-tasks'),'#/create':$('page-create'),'#/profile':$('page-profile')};
    const tabs=$('tabs'), authStatus=$('authStatus'), btnSignOut=$('btnSignOut');

    function show(el){ el.classList.remove('hidden'); } function hide(el){ el.classList.add('hidden'); }
    function toastMsg(m='Saved'){ toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1200); }
    const isDebug = location.search.includes('debug');
    const dlog=(m)=>{ if(!isDebug) return; debugBox.style.display='block'; debugBox.textContent+=m+'\\n'; };

    function routeActive(route){ document.querySelectorAll('.tabBtn').forEach(b=>b.classList.toggle('active', b.dataset.route===route)); }
    function go(route){
      if (!currentUser && route!=='#/auth') route = '#/auth';
      if (currentUser && route==='#/auth') route = '#/tasks';
      Object.entries(pages).forEach(([k,el])=> el.classList.toggle('hidden', k!==route));
      tabs.classList.toggle('hidden', !currentUser);
      routeActive(route);
      if (location.hash !== route) location.hash = route;
      window.scrollTo({top:0});
    }
    window.addEventListener('hashchange', ()=>go(location.hash||('#/auth')));
    document.querySelectorAll('.tabBtn').forEach(b=> b.onclick=()=> go(b.dataset.route));
    function setVh(){ const vh=Math.max(innerHeight, document.documentElement.clientHeight); document.documentElement.style.setProperty('--vh', vh+'px'); } setVh(); addEventListener('resize', setVh);

    /* ===== State ===== */
    let currentUser=null, isMod=false, allTasks=[];
    const usersMap=new Map(); let unsubUsers=null, unsubTasks=null;

    /* ===== DOM refs ===== */
    const emailEl=$('email'), passEl=$('password'), btnSignIn=$('btnSignIn'), btnSignUp=$('btnSignUp');
    const btnToggleFilters=$('btnToggleFilters'), filtersCard=$('filtersCard'), filtersBody=$('filtersBody');
    btnToggleFilters.onclick=()=>{ filtersCard.classList.toggle('open'); btnToggleFilters.textContent=filtersCard.classList.contains('open')?'Hide':'Show'; };
    const searchInput=$('searchInput'), statusFilter=$('statusFilter'), priorityFilter=$('priorityFilter'), scopeFilter=$('scopeFilter'), taskTbody=$('taskTbody');
    const newTitle=$('newTitle'), newDesc=$('newDesc'), newPriority=$('newPriority'), newDue=$('newDue'), newAssignees=$('newAssignees'), btnCreate=$('btnCreate'), modHint=$('modHint');
    const profName=$('profName'), profJob=$('profJob'), profPhoto=$('profPhoto'), btnSaveProfile=$('btnSaveProfile'), btnRefreshProfile=$('btnRefreshProfile');

    // Importer refs
    const csvSchedule=$('csvSchedule'), csvLibrary=$('csvLibrary'), btnParseCsv=$('btnParseCsv'), btnClearCsv=$('btnClearCsv');
    const csvInfo=$('csvInfo'), csvPreview=$('csvPreview'), csvList=$('csvList'), btnCreateCsvTasks=$('btnCreateCsvTasks');
    const impMonth=$('impMonth'), impYear=$('impYear');

    // Populate month/year selects
    (function initMonthYear(){
      const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      months.forEach((m,i)=>{ const o=document.createElement('option'); o.value=(i+1); o.textContent=m; impMonth.appendChild(o); });
      const yNow=new Date().getFullYear();
      for(let y=yNow-1;y<=yNow+2;y++){ const o=document.createElement('option'); o.value=y; o.textContent=y; impYear.appendChild(o); }
    })();

    /* ===== Helpers ===== */
    async function ensureUserProfile(user){
      const r=doc(db,'users',user.uid), s=await getDoc(r);
      if(!s.exists()) await setDoc(r,{uid:user.uid,email:user.email||'',name:'',jobTitle:'',photoURL:'',createdAt:serverTimestamp()});
    }
    async function isModerator(uid){ const s=await getDoc(doc(db,'moderators',uid)); return s.exists(); }
    async function loadMyProfile(uid){ const s=await getDoc(doc(db,'users',uid)); if(s.exists()){ const u=s.data(); profName.value=u.name||''; profJob.value=u.jobTitle||''; profPhoto.value=u.photoURL||''; } }
    async function saveMyProfile(uid){ await setDoc(doc(db,'users',uid),{name:profName.value.trim(),jobTitle:profJob.value.trim(),photoURL:profPhoto.value.trim(),updatedAt:serverTimestamp()},{merge:true}); }

    function uidToInitials(uid){ const u=usersMap.get(uid); const src=(u?.name?.trim()||u?.email||'??').split('@')[0]; const parts=src.replace(/[^a-zA-Z0-9 ]/g,' ').trim().split(/\s+/); return (parts[0]||'?').charAt(0).toUpperCase()+(parts[1]||'').charAt(0).toUpperCase(); }
    function avatarEl(uid){ const u=usersMap.get(uid)||{}; const el=document.createElement('div'); el.className='avatar'; if(u.photoURL) el.innerHTML=`<img src="${u.photoURL}" alt="">`; else el.textContent=uidToInitials(uid); return el; }
    function deriveStatus(t){ const a=(t.assignees||[]).length, c=(t.completedBy||[]).length; if(a===0||c===0) return 'todo'; if(c<a) return 'in_progress'; return 'done'; }
    function fillAssigneeSelect(sel){
      sel.innerHTML='';
      for (const [uid,u] of Array.from(usersMap.entries()).sort((a,b)=>(a[1].email||'').localeCompare(b[1].email||''))){
        const o=document.createElement('option'); o.value=uid; const nm=u.name?.trim()||'(no name)'; o.textContent=`${nm}${u.email?' ('+u.email+')':''}`; sel.appendChild(o);
      }
    }
    function endOfMonth(year, month1to12){ return new Date(year, month1to12, 0); } // pass (year, month) -> returns Date (last day)
    function priorityFromDaysLeft(daysLeft){ if(daysLeft<=10) return 'urgent'; if(daysLeft<=20) return 'high'; return 'normal'; }

    /* ===== Live data ===== */
    async function watchUsers(){
      if (unsubUsers){unsubUsers();unsubUsers=null;}
      const qUsers=query(collection(db,'users'),orderBy('email'));
      unsubUsers=onSnapshot(qUsers,(snap)=>{
        usersMap.clear();
        snap.forEach(d=>{const u=d.data(); usersMap.set(u.uid,{name:u.name||'',email:u.email||'',photoURL:u.photoURL||''});});
        fillAssigneeSelect(newAssignees);
        renderTasks();
      });
    }
    async function watchTasks(){
      if (unsubTasks){unsubTasks();unsubTasks=null;}
      const qy=(isMod&&scopeFilter.value==='all')?query(collection(db,'tasks'),orderBy('createdAt','desc')):query(collection(db,'tasks'),where('assignees','array-contains',currentUser.uid),orderBy('createdAt','desc'));
      unsubTasks=onSnapshot(qy,(snap)=>{ allTasks=snap.docs.map(d=>({id:d.id,...d.data()})); renderTasks(); });
    }

    /* ===== Render tasks ===== */
    function applyFilters(items){
      const q=(searchInput.value||'').toLowerCase(), fStatus=statusFilter.value, fPrio=priorityFilter.value, scope=isMod?scopeFilter.value:'mine';
      let arr=items.slice();
      if(scope==='mine'&&currentUser) arr=arr.filter(t=>(t.assignees||[]).includes(currentUser.uid));
      if(q) arr=arr.filter(t=>(t.title||'').toLowerCase().includes(q));
      if(fPrio!=='all') arr=arr.filter(t=>(t.priority||'normal')===fPrio);
      if(fStatus!=='all') arr=arr.filter(t=>{const st=deriveStatus(t); return fStatus==='done'?st==='done':(st==='todo'||st==='in_progress');});
      const rank={urgent:0,high:1,normal:2};
      arr.sort((a,b)=>{const pa=rank[a.priority||'normal']??2, pb=rank[b.priority||'normal']??2; if(pa!==pb) return pa-pb;
        const da=a.dueDate||'', db=b.dueDate||''; if(da!==db) return (da||'9999-99-99').localeCompare(db||'9999-99-99'); return (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0);});
      return arr;
    }
    function renderTasks(){
      const rows=applyFilters(allTasks); taskTbody.innerHTML='';
      rows.forEach(row=>{
        const tr=document.createElement('tr');

        const tdMe=document.createElement('td'); tdMe.setAttribute('data-label','Me');
        const amAssigned=(row.assignees||[]).includes(currentUser?.uid); const iAmDone=(row.completedBy||[]).includes(currentUser?.uid);
        const meCb=document.createElement('input'); meCb.type='checkbox'; meCb.checked=!!iAmDone; meCb.disabled=!amAssigned;
        meCb.onchange=async()=>{try{const ref=doc(db,'tasks',row.id); if(meCb.checked) await updateDoc(ref,{completedBy:arrayUnion(currentUser.uid),updatedAt:serverTimestamp()}); else await updateDoc(ref,{completedBy:arrayRemove(currentUser.uid),updatedAt:serverTimestamp()}); toastMsg('Updated'); }catch(e){ alert('Could not update: '+e.message); meCb.checked=!meCb.checked; }};
        tdMe.appendChild(meCb);

        const tdTitle=document.createElement('td'); tdTitle.setAttribute('data-label','Title');
        const dot=document.createElement('span'); const st=deriveStatus(row);
        dot.className='statusDot '+(st==='done'?'st-done':st==='in_progress'?'st-inprog':'st-todo');
        const ttl=document.createElement('span'); ttl.innerHTML=`<strong>${row.title||'(no title)'}</strong><br><span class="muted">${row.description||''}</span>`;
        tdTitle.appendChild(dot); tdTitle.appendChild(ttl);

        const tdPr=document.createElement('td'); tdPr.setAttribute('data-label','Priority');
        const pill=document.createElement('span'); const pr=(row.priority||'normal'); pill.className='pill '+(pr==='urgent'?'urgent':pr==='high'?'high':''); pill.textContent=pr.toUpperCase(); tdPr.appendChild(pill);

        const tdDue=document.createElement('td'); tdDue.setAttribute('data-label','Due'); tdDue.textContent=row.dueDate||'';

        const tdAs=document.createElement('td'); tdAs.setAttribute('data-label','Assignees');
        const avs=document.createElement('div'); avs.className='avatars'; const list=row.assignees||[]; const maxShow=4; list.slice(0,maxShow).forEach(uid=>avs.appendChild(avatarEl(uid)));
        if(list.length>maxShow){const more=document.createElement('div'); more.className='avatar more'; more.textContent=`+${list.length-maxShow}`; avs.appendChild(more);} tdAs.appendChild(avs);

        const tdDone=document.createElement('td'); tdDone.setAttribute('data-label','Done'); tdDone.textContent=`${(row.completedBy||[]).length}/${(row.assignees||[]).length}`;

        const tdAct=document.createElement('td'); tdAct.setAttribute('data-label','Actions');
        const bEdit=document.createElement('button'); bEdit.className='secondary'; bEdit.textContent='Edit';
        const bAssign=document.createElement('button'); bAssign.className='secondary'; bAssign.textContent='Assign';
        if(!isMod){ bEdit.disabled=true; bAssign.disabled=true; }
        tdAct.appendChild(bEdit); tdAct.appendChild(bAssign);

        // Inline editor (same as before)
        const trEdit=document.createElement('tr'); const tdEdit=document.createElement('td'); tdEdit.colSpan=7; trEdit.appendChild(tdEdit); trEdit.className='hidden';
        const panel=document.createElement('div'); panel.className='card';
        panel.innerHTML=`
          <div class="row"><input id="eTitle" placeholder="Title" value="${row.title||''}"></div>
          <div class="row"><textarea id="eDesc" placeholder="Description">${row.description||''}</textarea></div>
          <div class="row">
            <select id="ePrio">
              <option value="normal"${(row.priority||'normal')==='normal'?' selected':''}>Normal</option>
              <option value="high"${row.priority==='high'?' selected':''}>High</option>
              <option value="urgent"${row.priority==='urgent'?' selected':''}>Urgent</option>
            </select>
            <input id="eDue" type="date" value="${row.dueDate||''}">
          </div>
          <div class="row"><select id="eAss" multiple></select></div>
          <div class="row"><button id="eSave">Save</button><button id="eCancel" class="secondary">Cancel</button></div>`;
        tdEdit.appendChild(panel);
        function openEditor(){
          if(!isMod) return;
          trEdit.classList.remove('hidden');
          const sel=panel.querySelector('#eAss'); sel.innerHTML='';
          for (const [uid,u] of Array.from(usersMap.entries()).sort((a,b)=>(a[1].email||'').localeCompare(b[1].email||''))){
            const o=document.createElement('option'); o.value=uid; const nm=u.name?.trim()||'(no name)'; o.textContent=`${nm}${u.email?' ('+u.email+')':''}`; if((row.assignees||[]).includes(uid)) o.selected=true; sel.appendChild(o);
          }
          trEdit.scrollIntoView({behavior:'smooth', block:'center'});
        }
        bEdit.onclick=openEditor; bAssign.onclick=openEditor;
        panel.querySelector('#eCancel').onclick=()=> trEdit.classList.add('hidden');
        panel.querySelector('#eSave').onclick=async()=>{ try{
          const ref=doc(db,'tasks',row.id);
          const eTitle=panel.querySelector('#eTitle').value.trim()||'(no title)';
          const eDesc=panel.querySelector('#eDesc').value.trim();
          const ePrio=panel.querySelector('#ePrio').value;
          const eDue=panel.querySelector('#eDue').value||null;
          const newAssignees=Array.from(panel.querySelector('#eAss').selectedOptions).map(o=>o.value);
          await updateDoc(ref,{title:eTitle,description:eDesc,priority:ePrio,dueDate:eDue,assignees:newAssignees,updatedAt:serverTimestamp()});
          trEdit.classList.add('hidden'); toastMsg('Task updated');
        }catch(e){ alert('Save failed: '+e.message); }};

        tr.appendChild(tdMe); tr.appendChild(tdTitle); tr.appendChild(tdPr); tr.appendChild(tdDue); tr.appendChild(tdAs); tr.appendChild(tdDone); tr.appendChild(tdAct);
        taskTbody.appendChild(tr); taskTbody.appendChild(trEdit);
      });
    }

    /* ===== Create single task ===== */
    btnCreate.onclick=async()=>{
      if(!isMod) return alert('Only moderators can create.');
      const title=newTitle.value.trim(); if(!title) return alert('Enter a title');
      const desc=newDesc.value.trim(); const prio=newPriority.value||'normal'; const due=newDue.value||null;
      const ass=Array.from(newAssignees.selectedOptions).map(o=>o.value);
      const assignees=ass.length?ass:[currentUser.uid];
      await addDoc(collection(db,'tasks'),{title,description:desc,priority:prio,dueDate:due,assignees,completedBy:[],createdBy:currentUser.uid,createdAt:serverTimestamp(),updatedAt:serverTimestamp()});
      newTitle.value=''; newDesc.value=''; newPriority.value='normal'; newDue.value=''; for(const o of newAssignees.options)o.selected=false;
      toastMsg('Task created');
    };

    /* ===== CSV Importer ===== */
    btnClearCsv.onclick=()=>{ csvSchedule.value=''; csvLibrary.value=''; csvList.innerHTML=''; csvPreview.classList.add('hidden'); csvInfo.textContent=''; };
    function parseCsvFile(file){ return new Promise((resolve,reject)=> Papa.parse(file,{header:true,skipEmptyLines:true,complete:res=>resolve(res.data),error:reject})); }
    function nameToUid(name){
      const target=(name||'').toLowerCase().trim();
      for(const [uid,u] of usersMap.entries()){
        const nm=(u.name||'').toLowerCase();
        if(nm===target) return uid;
        if(nm.includes(target) || target.includes(nm)) return uid; // partial
      }
      return null;
    }
    function buildTasksFromCsv(scheduleRows, libRows, year, month){
      // Build ref -> {title, desc}
      const lib=new Map();
      libRows.forEach(r=>{
        const ref=String(r.Ref||r.ref||'').trim();
        const area=(r.Area||r.area||'').toString().trim();
        const focus=(r.Focus||r.focus||'').toString().trim();
        if(ref) lib.set(ref,{title:area||`Ref ${ref}`, desc: focus?`Focus: ${focus}`:''});
      });
      const last=endOfMonth(year, month); const endStr=last.toISOString().slice(0,10);
      const today=new Date(); const daysLeft=Math.ceil((last - new Date(today.getFullYear(), today.getMonth(), today.getDate()))/86400000);
      const basePriority=priorityFromDaysLeft(daysLeft);

      const tasks=[];
      scheduleRows.forEach(row=>{
        const rawName=row.Name||row.name||row.NAME; if(!rawName) return;
        const assigneeUid=nameToUid(String(rawName).replace(/\s+\(.*?\)/,'').trim()); // strip (Sup.) etc
        // Loop over day columns 1..31
        for(let d=1; d<=31; d++){
          const val=row[String(d)] ?? row[''+d]; if(!val) continue;
          const ref=String(val).trim(); if(!lib.has(ref)) continue;
          const {title,desc}=lib.get(ref);
          tasks.push({
            title, description:desc, dueDate:endStr, priority:basePriority,
            scheduledDay: d, ref, assignees: assigneeUid ? [assigneeUid] : [], unresolvedAssignee: assigneeUid? null : String(rawName).trim()
          });
        }
      });
      return tasks;
    }

    btnParseCsv.onclick=async()=>{
      if(!isMod) return alert('Only moderators can import.');
      const m=parseInt(impMonth.value,10), y=parseInt(impYear.value,10);
      if(!m||!y) return alert('Pick Month and Year');
      const f1=csvSchedule.files?.[0], f2=csvLibrary.files?.[0];
      if(!f1||!f2) return alert('Select both CSV files');

      try{
        csvInfo.textContent='Parsing‚Ä¶';
        const [sched, lib] = await Promise.all([parseCsvFile(f1), parseCsvFile(f2)]);
        const tasks = buildTasksFromCsv(sched, lib, y, m);
        if(!tasks.length){ csvInfo.innerHTML='<span class="danger">No tasks found. Check your CSV headers.</span>'; return; }
        csvInfo.innerHTML = `<span class="ok">Previewing ${tasks.length} task(s). Due: last day of ${m}/${y}. Priority auto-set by days left.</span>`;
        // Render preview
        csvList.innerHTML='';
        tasks.forEach((t,i)=>{
          const row=document.createElement('div'); row.className='card mini';
          const who = t.assignees.length ? '‚úî matched user' : `<span class="danger">‚ö† not matched: ${t.unresolvedAssignee}</span>`;
          row.innerHTML = `
            <div><strong>${t.title}</strong> ‚Äî ${t.description||''}</div>
            <div>Ref ${t.ref}, Day ${t.scheduledDay}, Due ${t.dueDate}, Priority ${t.priority}</div>
            <div>${who}</div>
          `;
          csvList.appendChild(row);
        });
        csvPreview.classList.remove('hidden');
        // store for Create
        btnCreateCsvTasks.dataset.payload = JSON.stringify(tasks);
      }catch(e){
        csvInfo.innerHTML=`<span class="danger">Parse failed: ${e.message}</span>`;
      }
    };

    btnCreateCsvTasks.onclick=async()=>{
      if(!isMod) return alert('Only moderators can create.');
      const raw=btnCreateCsvTasks.dataset.payload; if(!raw) return;
      const tasks=JSON.parse(raw);
      let created=0, skipped=0;
      for(const t of tasks){
        const ass = t.assignees.length ? t.assignees : (currentUser ? [currentUser.uid] : []);
        try{
          await addDoc(collection(db,'tasks'),{
            title:t.title, description:t.description, priority:t.priority, dueDate:t.dueDate,
            assignees:ass, completedBy:[], ref:t.ref, scheduledDay:t.scheduledDay,
            createdBy:currentUser.uid, createdAt:serverTimestamp(), updatedAt:serverTimestamp()
          });
          created++;
        }catch{ skipped++; }
      }
      toastMsg(`Created ${created} task(s)` + (skipped?`, skipped ${skipped}`:''));
      // reset preview
      csvPreview.classList.add('hidden'); csvList.innerHTML=''; csvInfo.textContent='';
      csvSchedule.value=''; csvLibrary.value='';
    };

    /* ===== OCR fallback (unchanged from before, trimmed here) ===== */
    // (kept minimal to focus on CSV; you can still use Scan Sheet if needed)
    const sheetImage=$('sheetImage'), sheetPreview=$('sheetPreview'), ocrStatus=$('ocrStatus');
    const btnExtract=$('btnExtract'), btnClearPreview=$('btnClearPreview'), previewList=$('previewList'), bulkActions=$('bulkActions');
    let ocrImageBlob=null;
    sheetImage.onchange=()=>{ const f=sheetImage.files?.[0]; if(!f) return; ocrImageBlob=f; sheetPreview.classList.remove('hidden'); ocrStatus.textContent=`Selected: ${f.name}`; previewList.innerHTML=''; bulkActions.classList.add('hidden'); };
    btnClearPreview.onclick=()=>{ sheetImage.value=''; ocrImageBlob=null; sheetPreview.classList.add('hidden'); ocrStatus.textContent=''; previewList.innerHTML=''; bulkActions.classList.add('hidden'); };
    btnExtract.onclick=()=> alert('For accuracy, use the CSV importer above. (OCR kept for emergencies.)');

    /* ===== Filters & profile ===== */
    [searchInput,statusFilter,priorityFilter].forEach(el=>{el.addEventListener('input',renderTasks);el.addEventListener('change',renderTasks);});
    scopeFilter.addEventListener('change',()=>watchTasks());
    btnSaveProfile.onclick=async()=>{ if(!currentUser) return; try{ await saveMyProfile(currentUser.uid); toastMsg('Profile saved'); }catch(e){ alert('Error: '+e.message);} };
    btnRefreshProfile.onclick=async()=>{ if(!currentUser) return; await loadMyProfile(currentUser.uid); };

    /* ===== Auth ===== */
    btnSignIn.onclick=async()=>{ try{ await signInWithEmailAndPassword(auth,emailEl.value,passEl.value);}catch(e){ alert(e.message); } };
    btnSignUp.onclick =async()=>{ try{ await createUserWithEmailAndPassword(auth,emailEl.value,passEl.value);}catch(e){ alert(e.message); } };
    btnSignOut.onclick=async()=>{ await signOut(auth); };

    async function startData(){ await watchUsers(); scopeFilter.classList.toggle('hidden', !isMod); scopeFilter.value='mine'; await watchTasks(); }

    onAuthStateChanged(auth, async (user)=>{
      currentUser=user||null;
      if(user){
        $('btnSignOut').classList.remove('hidden');
        authStatus.textContent=`Signed in`;
        await ensureUserProfile(user); await loadMyProfile(user.uid);
        isMod = await isModerator(user.uid);
        modHint.classList.toggle('hidden', isMod);
        startData(); go('#/tasks');
      }else{
        $('btnSignOut').classList.add('hidden');
        authStatus.textContent='Not signed in';
        if (unsubTasks){unsubTasks();unsubTasks=null;} if (unsubUsers){unsubUsers();unsubUsers=null;}
        allTasks=[]; renderTasks(); go('#/auth');
      }
    });

    // boot
    window.addEventListener('load', ()=> go(location.hash || '#/auth'));
  </script>
</body>
</html>