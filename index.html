<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Work Tasks</title>
  <style>
    :root{
      /* Alkegen brand */
      --brand:#002D62;      /* dark blue */
      --accent:#53A65C;     /* green */

      --bg:#0e1116; --card:#151a24; --text:#eef2f7; --muted:#a3adbd; --border:#273045;
      --shadow:0 12px 40px rgba(0,0,0,.5);
      --btn:var(--brand); --btn-text:#fff; --pill:#1d2433; --danger:#ff6b6b; --ok:#34d399;
      --tabbg:#0e1116; --tab-border:#1a2131; --vh:100svh;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#667085; --border:#e6e8ef; --shadow:0 10px 30px rgba(0,0,0,.08); --tabbg:#fff; --tab-border:#e6e8ef; }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    .navTop{position:sticky;top:0;z-index:20;backdrop-filter:blur(6px);
      background:linear-gradient(to bottom,color-mix(in srgb,var(--bg) 92%,transparent),transparent);
      border-bottom:2px solid color-mix(in srgb,var(--brand) 40%, var(--border))}
    .navTopInner{max-width:1100px;margin:0 auto;padding:8px 14px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    /* Poppier logo badge */
    .logoImg{
      width:28px;height:28px;border-radius:6px;object-fit:contain;
      background:#fff;padding:3px;border:2px solid var(--accent);
      box-shadow:0 0 4px rgba(0,0,0,0.2);
    }
    .brandText{font-size:14px}
    .grow{flex:1}
    .muted{color:var(--muted);font-size:12px}
    .topBtn{font-size:14px;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)}

    h3{margin:0 0 10px}
    h3::after{content:"";display:block;width:36px;height:3px;background:var(--accent);border-radius:2px;margin-top:6px}

    .app{max-width:1100px;margin:0 auto;padding:14px;padding-bottom:120px;min-height:calc(var(--vh) - 50px)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:14px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row>*{flex:1;min-width:150px}
    button,input,select,textarea{font-size:16px;padding:11px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text)}
    button{background:var(--btn);color:var(--btn-text);border:none}
    button.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
    button:active{transform:translateY(1px)}
    textarea{min-height:84px}
    .hint{font-size:12px;color:var(--muted)}
    .mini{font-size:12px}
    .divider{height:1px;background:var(--border);margin:8px 0}

    .tableWrap{overflow-x:auto;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{text-align:left;border-bottom:1px solid var(--border);padding:10px 8px;vertical-align:top}
    th{font-size:12px;text-transform:uppercase;letter-spacing:.02em;color:var(--muted)}
    tr:hover td{background:color-mix(in srgb,var(--card) 92%, transparent)}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:var(--pill);display:inline-block}
    .pill.high{background:color-mix(in srgb,var(--pill) 70%, #f0a000)}
    .pill.urgent{background:color-mix(in srgb,var(--pill) 70%, #d33)}
    .statusDot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;translate:0 2px}
    .st-todo{background:#a0a8b8}.st-inprog{background:#f0a000}.st-done{background:#2ecc71}
    .avatars{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .avatar{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:var(--pill);color:var(--text);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;overflow:hidden}
    .avatar.big{width:72px;height:72px;border-radius:50%}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .avatar.more{background:transparent;border:none;font-weight:600}

    @media (max-width: 760px){
      th{display:none}
      table, thead, tbody, tr, td{display:block;width:100%}
      tr{border-bottom:1px solid var(--border)}
      td{border:none;padding:10px 0}
      td[data-label]::before{content:attr(data-label) " ";font-size:12px;color:var(--muted);display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:.02em}
      .tableWrap{border:none}
      .brandText{display:none}
    }

    /* Bottom tabs with greener active state */
    .tabs{position:fixed;left:0;right:0;bottom:0;z-index:30;background:var(--tabbg);
      border-top:2px solid color-mix(in srgb,var(--brand) 40%, var(--tab-border));
      padding:8px 10px  calc(8px + env(safe-area-inset-bottom));
      display:flex;gap:10px;justify-content:space-around;box-shadow:0 -6px 20px rgba(0,0,0,.15)}
    .tabBtn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px;border-radius:12px;border:1px solid var(--border);
      background:transparent;color:var(--text);font-size:12px}
    .tabBtn.active{
      background:color-mix(in srgb, var(--accent) 16%, transparent);
      border-color:var(--accent);
      color:var(--accent);
      outline:2px solid color-mix(in srgb,var(--accent) 35%, transparent)
    }

    .toast{position:fixed;bottom:84px;left:50%;transform:translateX(-50%);background:var(--card);color:var(--text);border:1px solid var(--border);box-shadow:var(--shadow);border-radius:12px;padding:10px 14px;z-index:40;display:none}
    .toast.show{display:block}
    #debug{position:fixed;bottom:140px;left:8px;right:8px;background:#000a;color:#fff;padding:8px;border-radius:8px;font:12px monospace;z-index:50;display:none;max-height:40vh;overflow:auto}
    .hidden{display:none!important}
    .ok{color:var(--ok)} .danger{color:var(--danger)}

    .drop{border:2px dashed color-mix(in srgb,var(--brand) 40%, var(--border)); border-radius:12px; padding:16px; text-align:center}
    .drop.drag{background:color-mix(in srgb,var(--brand) 10%, transparent)}
  </style>
</head>
<body>
  <div class="navTop">
    <div class="navTopInner">
      <div class="brand">
        <img id="logoImg" class="logoImg" alt="Alkegen" />
        <span class="brandText">Work Tasks</span>
      </div>
      <div id="authStatus" class="muted">Not signed in</div>
      <div class="grow"></div>
      <button id="btnSignOut" class="topBtn hidden">Sign out</button>
    </div>
  </div>

  <div class="app">
    <!-- Auth -->
    <section id="page-auth" class="page">
      <div class="card">
        <h3>Sign in / Sign up</h3>
        <div class="row">
          <input id="email" type="email" placeholder="you@example.com" />
          <input id="password" type="password" placeholder="password (min 6 chars)" />
        </div>
        <div class="row">
          <button id="btnSignIn">Sign in</button>
          <button class="secondary" id="btnSignUp">Create account</button>
        </div>
        <p class="hint">Ask an admin to mark you as a moderator if needed.</p>
      </div>
    </section>

    <!-- Tasks -->
    <section id="page-tasks" class="page hidden">
      <div class="card" id="filtersCard">
        <div class="filtersHeader">
          <strong>Filters</strong>
          <button id="btnToggleFilters" class="secondary mini">Show</button>
        </div>
        <div class="filtersBody" id="filtersBody">
          <div class="row">
            <input id="searchInput" placeholder="Search title…" />
            <select id="statusFilter">
              <option value="all">Status: All</option>
              <option value="open">Status: Open</option>
              <option value="done">Status: Done</option>
            </select>
            <select id="priorityFilter">
              <option value="all">Priority: All</option>
              <option value="normal">Normal</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
            <select id="scopeFilter" class="hidden">
              <option value="mine">Show: Mine</option>
              <option value="all">Show: All</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card tableWrap">
        <table>
          <thead>
            <tr>
              <th>Me</th><th>Title</th><th>Priority</th><th>Due</th><th>Assignees</th><th>Done</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="taskTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Create -->
    <section id="page-create" class="page hidden">
      <div class="card">
        <h3>Create Task</h3>
        <div class="row"><input id="newTitle" placeholder="Task title" /></div>
        <div class="row"><textarea id="newDesc" placeholder="Description (optional)"></textarea></div>
        <div class="row">
          <select id="newPriority">
            <option value="normal">Normal</option>
            <option value="high">High</option>
            <option value="urgent">Urgent</option>
          </select>
          <input id="newDue" type="date" />
        </div>
        <div class="row">
          <select id="newAssignees" multiple><option value="">Pick assignees…</option></select>
        </div>
        <div class="row"><button id="btnCreate">Create task</button></div>
        <p id="modHint" class="hint hidden danger">Only moderators can create tasks.</p>
      </div>

      <!-- CSV importer -->
      <div class="card">
        <h3>Import from Spreadsheet (Single CSV)</h3>
        <p class="hint">Export the whole sheet as CSV. Expected: A=Name, B=Count(ignored), C…AG=Days (Refs), AH=Area, AI=Ref, AJ/AK ignored.</p>
        <div class="row">
          <select id="impMonth"><option value="">Month…</option></select>
          <select id="impYear"><option value="">Year…</option></select>
        </div>
        <div class="row">
          <input id="csvOne" type="file" accept=".csv" />
        </div>
        <div class="row">
          <button id="btnParseSingleCsv" class="secondary">Preview tasks</button>
          <button id="btnClearCsv" class="secondary">Clear</button>
        </div>
        <div id="csvInfo" class="hint"></div>
        <div id="csvPreview" class="hidden">
          <div class="divider"></div>
          <div class="row"><button id="btnCreateCsvTasks">Create all tasks shown</button></div>
          <div id="csvList" class="mini" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- OCR importer -->
      <div class="card">
        <h3>Scan Sheet (Photo)</h3>
        <p class="hint">Choose from camera or gallery. Drag & drop works on desktop. CSV is still most accurate.</p>
        <div class="row">
          <input id="sheetImage" type="file" accept="image/*" />
        </div>
        <div id="dropZone" class="drop mini">Drag & drop an image here</div>
        <div id="ocrStatus" class="hint"></div>
        <div id="sheetPreview" class="hidden">
          <div class="divider"></div>
          <div class="row">
            <button id="btnExtract" class="secondary">Recognize & Preview</button>
            <button id="btnClearPreview" class="secondary">Clear</button>
          </div>
          <div id="previewList" class="mini" style="margin-top:8px"></div>
          <div class="row hidden" id="bulkActions">
            <button id="btnCreateFromPreview">Create selected tasks</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Profile -->
    <section id="page-profile" class="page hidden">
      <div class="card">
        <h3>Your Profile</h3>
        <!-- Avatar preview -->
        <div class="row" style="align-items:center">
          <div class="avatar big"><img id="profAvatarImg" alt="" /></div>
          <div class="hint">This photo shows on your tasks for teammates.</div>
        </div>
        <div class="row">
          <input id="profName" placeholder="Your name" />
          <input id="profJob" placeholder="Job title (e.g., Supervisor)" />
        </div>
        <input id="profPhoto" placeholder="Photo URL (optional)" />
        <div class="row">
          <input id="profPhotoFile" type="file" accept="image/*" />
          <button id="btnUploadPhoto" class="secondary">Upload photo</button>
        </div>
        <div class="row">
          <button id="btnSaveProfile">Save Profile</button>
          <button class="secondary" id="btnRefreshProfile">Refresh</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Tabs -->
  <div class="tabs hidden" id="tabs">
    <button class="tabBtn" data-route="#/tasks"><span class="tabIcon">🗂️</span><span>Tasks</span></button>
    <button class="tabBtn" data-route="#/create"><span class="tabIcon">📄</span><span>Create</span></button>
    <button class="tabBtn" data-route="#/profile"><span class="tabIcon">👤</span><span>Profile</span></button>
  </div>

  <div id="toast" class="toast">Saved</div>
  <div id="debug"></div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js" defer></script>

  <script type="module">
    /* Error surface */
    window.addEventListener('error', e => {
      const box = document.getElementById('debug');
      box.style.display='block';
      box.textContent += 'Error: ' + (e.message || e.error?.message) + '\\n';
    });

    /* Logo */
    const LOGO_URL = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTrdeEzoxxBXtrF9equxIeFP61GsGUqShoIzTWqNmdasXfrYwtDg2Az7Q&s=10";
    const logoImg = document.getElementById('logoImg');
    if (LOGO_URL) logoImg.src = LOGO_URL;

    /* Firebase */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, updateDoc, addDoc, serverTimestamp, getDoc, setDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBrErkwzc9mucItWzBv5eBupfqRLqS2eDk",
      authDomain: "gemba-bso-walk.firebaseapp.com",
      projectId: "gemba-bso-walk",
      storageBucket: "gemba-bso-walk.firebasestorage.app",
      messagingSenderId: "1032855791471",
      appId: "1:1032855791471:web:1680e88857174c60d26a9a"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const storage = getStorage(app);

    /* Utilities & routing */
    const $ = (id)=>document.getElementById(id);
    const toast = $('toast');
    const pages={'#/auth':$('page-auth'),'#/tasks':$('page-tasks'),'#/create':$('page-create'),'#/profile':$('page-profile')};
    const tabs=$('tabs'), authStatus=$('authStatus'), btnSignOut=$('btnSignOut');

    function toastMsg(m='Saved'){ toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1200); }
    function routeActive(route){ document.querySelectorAll('.tabBtn').forEach(b=>b.classList.toggle('active', b.dataset.route===route)); }
    function go(route){
      if (!currentUser && route!=='#/auth') route = '#/auth';
      if (currentUser && route==='#/auth') route = '#/tasks';
      Object.entries(pages).forEach(([k,el])=> el.classList.toggle('hidden', k!==route));
      tabs.classList.toggle('hidden', !currentUser);
      routeActive(route);
      if (location.hash !== route) location.hash = route;
      window.scrollTo({top:0});
    }
    window.addEventListener('hashchange', ()=>go(location.hash||('#/auth')));
    document.querySelectorAll('.tabBtn').forEach(b=> b.onclick=()=> go(b.dataset.route));
    function setVh(){ const vh=Math.max(innerHeight, document.documentElement.clientHeight); document.documentElement.style.setProperty('--vh', vh+'px'); } setVh(); addEventListener('resize', setVh);

    /* State */
    let currentUser=null, isMod=false, allTasks=[];
    const usersMap=new Map(); let unsubUsers=null, unsubTasks=null;

    /* Helpers */
    async function ensureUserProfile(user){
      const r=doc(db,'users',user.uid), s=await getDoc(r);
      if(!s.exists()) await setDoc(r,{uid:user.uid,email:user.email||'',name:'',jobTitle:'',photoURL:'',createdAt:serverTimestamp()});
    }
    async function isModerator(uid){ const s=await getDoc(doc(db,'moderators',uid)); return s.exists(); }
    async function loadMyProfile(uid){
      const s=await getDoc(doc(db,'users',uid));
      if(s.exists()){
        const u=s.data();
        $('profName').value=u.name||'';
        $('profJob').value=u.jobTitle||'';
        $('profPhoto').value=u.photoURL||'';
        $('profAvatarImg').src = u.photoURL || '';
      }
    }
    async function saveMyProfile(uid){
      await setDoc(doc(db,'users',uid),{
        name:$('profName').value.trim(),
        jobTitle:$('profJob').value.trim(),
        photoURL:$('profPhoto').value.trim(),
        updatedAt:serverTimestamp()
      },{merge:true});
      $('profAvatarImg').src = $('profPhoto').value.trim() || '';
    }
    function uidToInitials(uid){ const u=usersMap.get(uid); const src=(u?.name?.trim()||u?.email||'??').split('@')[0]; const parts=src.replace(/[^a-zA-Z0-9 ]/g,' ').trim().split(/\s+/); return (parts[0]||'?').charAt(0).toUpperCase()+(parts[1]||'').charAt(0).toUpperCase(); }
    function avatarEl(uid){ const u=usersMap.get(uid)||{}; const el=document.createElement('div'); el.className='avatar'; if(u.photoURL) el.innerHTML=`<img src="${u.photoURL}" alt="">`; else el.textContent=uidToInitials(uid); return el; }
    function deriveStatus(t){ const a=(t.assignees||[]).length, c=(t.completedBy||[]).length; if(a===0||c===0) return 'todo'; if(c<a) return 'in_progress'; return 'done'; }
    function endOfMonth(year, month1to12){ return new Date(year, month1to12, 0); }
    function priorityFromDaysLeft(daysLeft){ if(daysLeft<=10) return 'urgent'; if(daysLeft<=20) return 'high'; return 'normal'; }
    function nameToUid(name){
      const target=(name||'').toLowerCase().trim().replace(/\s+\(.*?\)\s*$/,'');
      for(const [uid,u] of usersMap.entries()){
        const nm=(u.name||'').toLowerCase().trim();
        if(!nm) continue;
        if(nm===target) return uid;
        if(nm.includes(target) || target.includes(nm)) return uid;
      }
      return null;
    }
    function fillAssigneeSelect(sel){
      sel.innerHTML='';
      for (const [uid,u] of Array.from(usersMap.entries()).sort((a,b)=>(a[1].email||'').localeCompare(b[1].email||''))){
        const o=document.createElement('option'); o.value=uid; const nm=u.name?.trim()||'(no name)'; o.textContent=`${nm}${u.email?' ('+u.email+')':''}`; sel.appendChild(o);
      }
    }

    /* DOM refs */
    const emailEl=$('email'), passEl=$('password'), btnSignIn=$('btnSignIn'), btnSignUp=$('btnSignUp');
    const btnToggleFilters=$('btnToggleFilters'), filtersCard=$('filtersCard');
    const searchInput=$('searchInput'), statusFilter=$('statusFilter'), priorityFilter=$('priorityFilter'), scopeFilter=$('scopeFilter'), taskTbody=$('taskTbody');
    const newTitle=$('newTitle'), newDesc=$('newDesc'), newPriority=$('newPriority'), newDue=$('newDue'), newAssignees=$('newAssignees'), modHint=$('modHint');

    // CSV / Month-Year
    const impMonth=$('impMonth'), impYear=$('impYear'), csvOne=$('csvOne'), btnParseSingleCsv=$('btnParseSingleCsv'), btnClearCsv=$('btnClearCsv');
    const csvInfo=$('csvInfo'), csvPreview=$('csvPreview'), csvList=$('csvList'), btnCreateCsvTasks=$('btnCreateCsvTasks');

    // OCR
    const sheetImage=$('sheetImage'), dropZone=$('dropZone');
    const ocrStatus=$('ocrStatus'), sheetPreview=$('sheetPreview'), btnExtract=$('btnExtract'), btnClearPreview=$('btnClearPreview');
    const previewList=$('previewList'), bulkActions=$('bulkActions'), btnCreateFromPreview=$('btnCreateFromPreview');

    // Profile photo upload refs
    const profPhoto=$('profPhoto'), profPhotoFile=$('profPhotoFile'), btnUploadPhoto=$('btnUploadPhoto');

    // Populate Month/Year options
    function populateMonthYear(){
      impMonth.innerHTML = '<option value="">Month…</option>';
      const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      months.forEach((m,i)=>{ const o=document.createElement('option'); o.value=(i+1); o.textContent=m; impMonth.appendChild(o); });
      impYear.innerHTML = '<option value="">Year…</option>';
      const yNow=new Date().getFullYear();
      for(let y=yNow-1;y<=yNow+2;y++){ const o=document.createElement('option'); o.value=y; o.textContent=y; impYear.appendChild(o); }
    }
    populateMonthYear();

    /* Filters */
    btnToggleFilters.onclick=()=>{ filtersCard.classList.toggle('open'); btnToggleFilters.textContent=filtersCard.classList.contains('open')?'Hide':'Show'; };
    [searchInput,statusFilter,priorityFilter].forEach(el=>{el.addEventListener('input',renderTasks);el.addEventListener('change',renderTasks);});
    scopeFilter.addEventListener('change',()=>watchTasks());

    /* Live data */
    async function watchUsers(){
      if (unsubUsers){unsubUsers();unsubUsers=null;}
      const qUsers=query(collection(db,'users'),orderBy('email'));
      unsubUsers=onSnapshot(qUsers,(snap)=>{
        usersMap.clear();
        snap.forEach(d=>{const u=d.data(); usersMap.set(u.uid,{name:u.name||'',email:u.email||'',photoURL:u.photoURL||''});});
        fillAssigneeSelect(newAssignees);
        renderTasks();
      });
    }
    async function watchTasks(){
      if (unsubTasks){unsubTasks();unsubTasks=null;}
      const qy=(isMod&&scopeFilter.value==='all')?query(collection(db,'tasks'),orderBy('createdAt','desc')):query(collection(db,'tasks'),where('assignees','array-contains',currentUser.uid),orderBy('createdAt','desc'));
      unsubTasks=onSnapshot(qy,(snap)=>{ allTasks=snap.docs.map(d=>({id:d.id,...d.data()})); renderTasks(); });
    }

    /* Render tasks */
    function applyFilters(items){
      const q=(searchInput.value||'').toLowerCase(), fStatus=statusFilter.value, fPrio=priorityFilter.value, scope=isMod?scopeFilter.value:'mine';
      let arr=items.slice();
      if(scope==='mine'&&currentUser) arr=arr.filter(t=>(t.assignees||[]).includes(currentUser.uid));
      if(q) arr=arr.filter(t=>(t.title||'').toLowerCase().includes(q));
      if(fPrio!=='all') arr=arr.filter(t=>(t.priority||'normal')===fPrio);
      if(fStatus!=='all') arr=arr.filter(t=>{const st=deriveStatus(t); return fStatus==='done'?st==='done':(st==='todo'||st==='in_progress');});
      const rank={urgent:0,high:1,normal:2};
      arr.sort((a,b)=>{const pa=rank[a.priority||'normal']??2, pb=rank[b.priority||'normal']??2; if(pa!==pb) return pa-pb;
        const da=a.dueDate||'', db=b.dueDate||''; if(da!==db) return (da||'9999-99-99').localeCompare(db||'9999-99-99'); return (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0);});
      return arr;
    }
    function avatarInitials(uid){
      const u=usersMap.get(uid);
      const src=(u?.name?.trim()||u?.email||'??').split('@')[0];
      const parts=src.replace(/[^a-zA-Z0-9 ]/g,' ').trim().split(/\s+/);
      return (parts[0]||'?').charAt(0).toUpperCase()+(parts[1]||'').charAt(0).toUpperCase();
    }
    function renderTasks(){
      const rows=applyFilters(allTasks); taskTbody.innerHTML='';
      rows.forEach(row=>{
        const tr=document.createElement('tr');

        const tdMe=document.createElement('td'); tdMe.setAttribute('data-label','Me');
        const amAssigned=(row.assignees||[]).includes(currentUser?.uid); const iAmDone=(row.completedBy||[]).includes(currentUser?.uid);
        const meCb=document.createElement('input'); meCb.type='checkbox'; meCb.checked=!!iAmDone; meCb.disabled=!amAssigned;
        meCb.onchange=async()=>{try{const ref=doc(db,'tasks',row.id); if(meCb.checked) await updateDoc(ref,{completedBy:arrayUnion(currentUser.uid),updatedAt:serverTimestamp()}); else await updateDoc(ref,{completedBy:arrayRemove(currentUser.uid),updatedAt:serverTimestamp()}); toastMsg('Updated'); }catch(e){ alert('Could not update: '+e.message); meCb.checked=!meCb.checked; }};
        tdMe.appendChild(meCb);

        const tdTitle=document.createElement('td'); tdTitle.setAttribute('data-label','Title');
        const dot=document.createElement('span'); const st=deriveStatus(row);
        dot.className='statusDot '+(st==='done'?'st-done':st==='in_progress'?'st-inprog':'st-todo');
        const ttl=document.createElement('span'); ttl.innerHTML=`<strong>${row.title||'(no title)'}</strong><br><span class="muted">${row.description||''}</span>`;
        tdTitle.appendChild(dot); tdTitle.appendChild(ttl);

        const tdPr=document.createElement('td'); tdPr.setAttribute('data-label','Priority');
        const pill=document.createElement('span'); const pr=(row.priority||'normal'); pill.className='pill '+(pr==='urgent'?'urgent':pr==='high'?'high':''); pill.textContent=pr.toUpperCase(); tdPr.appendChild(pill);

        const tdDue=document.createElement('td'); tdDue.setAttribute('data-label','Due'); tdDue.textContent=row.dueDate||'';

        const tdAs=document.createElement('td'); tdAs.setAttribute('data-label','Assignees');
        const avs=document.createElement('div'); avs.className='avatars';
        const list=row.assignees||[]; const maxShow=4;
        list.slice(0,maxShow).forEach(uid=>{
          const u=usersMap.get(uid)||{};
          const av=document.createElement('div'); av.className='avatar';
          if(u.photoURL) av.innerHTML = `<img src="${u.photoURL}" alt="">`; else av.textContent = avatarInitials(uid);
          avs.appendChild(av);
        });
        if(list.length>maxShow){const more=document.createElement('div'); more.className='avatar more'; more.textContent=`+${list.length-maxShow}`; avs.appendChild(more);} tdAs.appendChild(avs);

        const tdDone=document.createElement('td'); tdDone.setAttribute('data-label','Done'); tdDone.textContent=`${(row.completedBy||[]).length}/${(row.assignees||[]).length}`;

        const tdAct=document.createElement('td'); tdAct.setAttribute('data-label','Actions');
        const bEdit=document.createElement('button'); bEdit.className='secondary'; bEdit.textContent='Edit';
        const bAssign=document.createElement('button'); bAssign.className='secondary'; bAssign.textContent='Assign';
        if(!isMod){ bEdit.disabled=true; bAssign.disabled=true; }
        tdAct.appendChild(bEdit); tdAct.appendChild(bAssign);

        const trEdit=document.createElement('tr'); const tdEdit=document.createElement('td'); tdEdit.colSpan=7; trEdit.appendChild(tdEdit); trEdit.className='hidden';
        const panel=document.createElement('div'); panel.className='card';
        panel.innerHTML=`
          <div class="row"><input id="eTitle" placeholder="Title" value="${row.title||''}"></div>
          <div class="row"><textarea id="eDesc" placeholder="Description">${row.description||''}</textarea></div>
          <div class="row">
            <select id="ePrio">
              <option value="normal"${(row.priority||'normal')==='normal'?' selected':''}>Normal</option>
              <option value="high"${row.priority==='high'?' selected':''}>High</option>
              <option value="urgent"${row.priority==='urgent'?' selected':''}>Urgent</option>
            </select>
            <input id="eDue" type="date" value="${row.dueDate||''}">
          </div>
          <div class="row"><select id="eAss" multiple></select></div>
          <div class="row"><button id="eSave">Save</button><button id="eCancel" class="secondary">Cancel</button></div>`;
        tdEdit.appendChild(panel);
        function openEditor(){
          if(!isMod) return;
          trEdit.classList.remove('hidden');
          const sel=panel.querySelector('#eAss'); sel.innerHTML='';
          for (const [uid,u] of Array.from(usersMap.entries()).sort((a,b)=>(a[1].email||'').localeCompare(b[1].email||''))){
            const o=document.createElement('option'); o.value=uid; const nm=u.name?.trim()||'(no name)'; o.textContent=`${nm}${u.email?' ('+u.email+')':''}`; if((row.assignees||[]).includes(uid)) o.selected=true; sel.appendChild(o);
          }
          trEdit.scrollIntoView({behavior:'smooth', block:'center'});
        }
        bEdit.onclick=openEditor; bAssign.onclick=openEditor;
        panel.querySelector('#eCancel').onclick=()=> trEdit.classList.add('hidden');
        panel.querySelector('#eSave').onclick=async()=>{ try{
          const ref=doc(db,'tasks',row.id);
          const eTitle=panel.querySelector('#eTitle').value.trim()||'(no title)';
          const eDesc=panel.querySelector('#eDesc').value.trim();
          const ePrio=panel.querySelector('#ePrio').value;
          const eDue=panel.querySelector('#eDue').value||null;
          const newAssignees=Array.from(panel.querySelector('#eAss').selectedOptions).map(o=>o.value);
          await updateDoc(ref,{title:eTitle,description:eDesc,priority:ePrio,dueDate:eDue,assignees:newAssignees,updatedAt:serverTimestamp()});
          trEdit.classList.add('hidden'); toastMsg('Task updated');
        }catch(e){ alert('Save failed: '+e.message); }};

        tr.appendChild(tdMe); tr.appendChild(tdTitle); tr.appendChild(tdPr); tr.appendChild(tdDue); tr.appendChild(tdAs); tr.appendChild(tdDone); tr.appendChild(tdAct);
        taskTbody.appendChild(tr); taskTbody.appendChild(trEdit);
      });
    }

    /* Create single task */
    $('btnCreate').onclick=async()=>{
      if(!isMod) return alert('Only moderators can create.');
      const title=newTitle.value.trim(); if(!title) return alert('Enter a title');
      const desc=newDesc.value.trim(); const prio=newPriority.value||'normal'; const due=newDue.value||null;
      const ass=Array.from(newAssignees.selectedOptions).map(o=>o.value);
      const assignees=ass.length?ass:[currentUser.uid];
      await addDoc(collection(db,'tasks'),{title,description:desc,priority:prio,dueDate:due,assignees,completedBy:[],createdBy:currentUser.uid,createdAt:serverTimestamp(),updatedAt:serverTimestamp()});
      newTitle.value=''; newDesc.value=''; newPriority.value='normal'; newDue.value=''; for(const o of newAssignees.options)o.selected=false;
      toastMsg('Task created');
    };

    /* CSV (single) */
    function parseCsvRaw(file){ return new Promise((resolve,reject)=> Papa.parse(file,{header:false,skipEmptyLines:true,complete:res=>resolve(res.data),error:reject})); }
    function splitAreaFocus(areaCell){
      if(!areaCell) return {title:'', desc:''};
      let s=String(areaCell).trim(); let title=s, desc='';
      const focusMatch = s.match(/^(.*?)[–-]\s*focus on\s*(.*)$/i);
      if(focusMatch){ title=focusMatch[1].trim(); desc='Focus: '+focusMatch[2].trim(); }
      else{ const dash = s.split(/–|-/); if(dash.length>1){ title=dash[0].trim(); desc=dash.slice(1).join('-').trim(); } }
      return {title, desc};
    }
    function buildTasksFromSingleCsv(rows, year, month){
      const COL_NAME=0, COL_DAY_START=2, COL_DAY_END=32, COL_AREA=33, COL_REF=34;
      const lib = new Map();
      for(const r of rows){
        const area=r[COL_AREA], ref=r[COL_REF];
        if(area && ref){
          const {title, desc} = splitAreaFocus(area);
          lib.set(String(ref).trim(), {title: title || `Ref ${ref}`, desc});
        }
      }
      const last=endOfMonth(year, month); const dueStr=last.toISOString().slice(0,10);
      const today=new Date(); const daysLeft=Math.ceil((last - new Date(today.getFullYear(), today.getMonth(), today.getDate()))/86400000);
      const basePriority=priorityFromDaysLeft(daysLeft);
      const tasks=[];
      for(const r of rows){
        const name=r[COL_NAME]; if(!name) continue;
        let hasAny=false; for(let c=COL_DAY_START;c<=COL_DAY_END;c++){ if(r[c]){hasAny=true;break;} } if(!hasAny) continue;
        const assUid = nameToUid(String(name));
        for(let day=1; day<=31; day++){
          const col = COL_DAY_START + (day-1); const v = r[col]; if(!v) continue;
          const ref = String(v).trim(); if(!lib.has(ref)) continue;
          const {title, desc} = lib.get(ref);
          tasks.push({title, description:desc, dueDate:dueStr, priority:basePriority, scheduledDay: day, ref, assignees: assUid ? [assUid] : [], unresolvedAssignee: assUid? null : String(name).trim()});
        }
      }
      return tasks;
    }
    btnClearCsv.onclick=()=>{ csvOne.value=''; csvList.innerHTML=''; csvPreview.classList.add('hidden'); csvInfo.textContent=''; };
    btnParseSingleCsv.onclick=async()=>{
      if(!isMod) return alert('Only moderators can import.');
      const m=parseInt(impMonth.value,10), y=parseInt(impYear.value,10);
      if(!m||!y) return alert('Pick Month and Year');
      const f=csvOne.files?.[0]; if(!f) return alert('Select the CSV file');
      try{
        csvInfo.textContent='Parsing…';
        const rows = await parseCsvRaw(f);
        const tasks = buildTasksFromSingleCsv(rows, y, m);
        if(!tasks.length){ csvInfo.innerHTML='<span class="danger">No tasks found. Check CSV layout.</span>'; return; }
        csvInfo.innerHTML = `<span class="ok">Previewing ${tasks.length} task(s). Due: last day of ${m}/${y}. Priority auto-set by days left.</span>`;
        csvList.innerHTML='';
        tasks.forEach((t)=>{ const row=document.createElement('div'); row.className='card mini';
          const who = t.assignees.length ? '✔ matched user' : `<span class="danger">⚠ not matched: ${t.unresolvedAssignee}</span>`;
          row.innerHTML = `<div><strong>${t.title}</strong> — ${t.description||''}</div><div>Ref ${t.ref}, Day ${t.scheduledDay}, Due ${t.dueDate}, Priority ${t.priority}</div><div>${who}</div>`;
          csvList.appendChild(row);
        });
        csvPreview.classList.remove('hidden');
        btnCreateCsvTasks.dataset.payload = JSON.stringify(tasks);
      }catch(e){ csvInfo.innerHTML=`<span class="danger">Parse failed: ${e.message}</span>`; }
    };
    btnCreateCsvTasks.onclick=async()=>{
      if(!isMod) return alert('Only moderators can create.');
      const raw=btnCreateCsvTasks.dataset.payload; if(!raw) return;
      const tasks=JSON.parse(raw);
      let created=0, skipped=0;
      for(const t of tasks){
        const ass = t.assignees.length ? t.assignees : (currentUser ? [currentUser.uid] : []);
        try{
          await addDoc(collection(db,'tasks'),{ title:t.title, description:t.description, priority:t.priority, dueDate:t.dueDate, assignees:ass, completedBy:[], ref:t.ref, scheduledDay:t.scheduledDay, createdBy:currentUser.uid, createdAt:serverTimestamp(), updatedAt:serverTimestamp() });
          created++;
        }catch{ skipped++; }
      }
      toastMsg(`Created ${created} task(s)` + (skipped?`, skipped ${skipped}`:''));
      csvPreview.classList.add('hidden'); csvList.innerHTML=''; csvInfo.textContent=''; csvOne.value='';
    };

    /* OCR (camera or gallery + drag&drop) */
    let ocrImageBlob = null;
    sheetImage.onchange = () => { const f = sheetImage.files?.[0]; if(!f) return; ocrImageBlob=f; sheetPreview.classList.remove('hidden'); ocrStatus.textContent=`Selected: ${f.name}`; previewList.innerHTML=''; bulkActions.classList.add('hidden'); };
    ;['dragenter','dragover'].forEach(evt=>dropZone.addEventListener(evt,e=>{e.preventDefault(); dropZone.classList.add('drag');}));
    ;['dragleave','drop'].forEach(evt=>dropZone.addEventListener(evt,e=>{e.preventDefault(); dropZone.classList.remove('drag');}));
    dropZone.addEventListener('drop', (e)=>{ const f=e.dataTransfer.files?.[0]; if(f && f.type.startsWith('image/')){ ocrImageBlob=f; sheetPreview.classList.remove('hidden'); ocrStatus.textContent=`Selected: ${f.name}`; previewList.innerHTML=''; bulkActions.classList.add('hidden'); } });

    function parseOcrToTasks(rawText, year, month){
      const lines = rawText.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const lib = new Map();
      for(const ln of lines){
        const m = ln.match(/^(.*?)(?:\s*[–-]\s*focus on\s*(.*?))?\s+ref[:\s]*([0-9]+)\b/i);
        if(m){
          const area=m[1].trim(); const focus=m[2]?.trim(); const ref=String(m[3]).trim();
          const {title, desc} = splitAreaFocus(focus ? `${area} – focus on ${focus}` : area);
          lib.set(ref,{title,desc});
        }
      }
      const last=endOfMonth(year, month); const dueStr=last.toISOString().slice(0,10);
      const today=new Date(); const daysLeft=Math.ceil((last - new Date(today.getFullYear(), today.getMonth(), today.getDate()))/86400000);
      const basePriority=priorityFromDaysLeft(daysLeft);

      const tasks=[];
      for(const ln of lines){
        const nameMatch = ln.match(/^([A-Za-z][A-Za-z .()'-]+)\s+(.*)$/);
        if(!nameMatch) continue;
        const name = nameMatch[1].trim();
        const rest = nameMatch[2];
        const refs = rest.match(/\b([0-9]{1,2})\b/g) || [];
        if(refs.length===0) continue;
        const assUid = nameToUid(name);
        refs.forEach((ref, idx)=>{
          if(!lib.has(ref)) return;
          const {title, desc}=lib.get(ref);
          tasks.push({title, description:desc, dueDate:dueStr, priority:basePriority, scheduledDay: idx+1, ref, assignees: assUid ? [assUid] : [], unresolvedAssignee: assUid? null : name});
        });
      }
      return tasks;
    }

    $('btnClearPreview').onclick = () => { sheetImage.value = ''; ocrImageBlob = null; sheetPreview.classList.add('hidden'); ocrStatus.textContent = ''; previewList.innerHTML = ''; $('bulkActions').classList.add('hidden'); };
    $('btnExtract').onclick = async () => {
      if (!isMod) return alert('Only moderators can use Scan Sheet.');
      if (!ocrImageBlob) return alert('Choose an image first.');
      const m=parseInt(impMonth.value,10), y=parseInt(impYear.value,10);
      if(!m||!y) return alert('Pick Month and Year (used for due date)');
      if (!window.Tesseract) return alert('OCR library not loaded yet.');

      ocrStatus.textContent = 'Reading image…'; previewList.innerHTML=''; $('bulkActions').classList.add('hidden');
      try{
        const { data } = await Tesseract.recognize(ocrImageBlob, 'eng', { logger: m => { if (m.status) ocrStatus.textContent = `${m.status} ${m.progress?Math.round(m.progress*100)+'%':''}`; } });
        const tasks = parseOcrToTasks(data.text||'', y, m);
        if(!tasks.length){ ocrStatus.innerHTML = '<span class="danger">Could not parse tasks from photo. Try CSV for accuracy.</span>'; return; }
        ocrStatus.innerHTML = `<span class="ok">Parsed ${tasks.length} candidate task(s). Review below.</span>`;
        tasks.forEach((t,i)=>{
          const row=document.createElement('div'); row.className='card mini';
          const who = t.assignees.length ? '✔ matched user' : `<span class="danger">⚠ not matched: ${t.unresolvedAssignee}</span>`;
          row.innerHTML = `<label class="mini"><input type="checkbox" class="pv-check" data-i="${i}" checked> Create</label>
            <div><strong>${t.title}</strong> — ${t.description||''}</div>
            <div>Ref ${t.ref}, Day ${t.scheduledDay}, Due ${t.dueDate}, Priority ${t.priority}</div>
            <div>${who}</div>`;
          previewList.appendChild(row);
        });
        $('bulkActions').classList.remove('hidden');
        $('btnCreateFromPreview').onclick = async ()=>{
          let created=0;
          const checks = previewList.querySelectorAll('.pv-check');
          for(const chk of checks){
            if(!chk.checked) continue;
            const i = parseInt(chk.dataset.i,10);
            const t = tasks[i];
            const ass = t.assignees.length ? t.assignees : (currentUser ? [currentUser.uid] : []);
            await addDoc(collection(db,'tasks'),{ title:t.title, description:t.description, priority:t.priority, dueDate:t.dueDate, assignees:ass, completedBy:[], ref:t.ref, scheduledDay:t.scheduledDay, createdBy:currentUser.uid, createdAt:serverTimestamp(), updatedAt:serverTimestamp() });
            created++;
          }
          toastMsg(`Created ${created} task(s)`); $('btnClearPreview').click();
        };
      }catch(e){ console.error(e); ocrStatus.innerHTML = `<span class="danger">OCR failed: ${e.message}</span>`; }
    };

    /* Profile actions (incl. upload) */
    $('btnSaveProfile').onclick=async()=>{ if(!currentUser) return; try{ await saveMyProfile(currentUser.uid); toastMsg('Profile saved'); }catch(e){ alert('Error: '+e.message);} };
    $('btnRefreshProfile').onclick=async()=>{ if(!currentUser) return; await loadMyProfile(currentUser.uid); };
    $('btnUploadPhoto').onclick = async ()=>{
      if(!currentUser) return alert('Sign in first.');
      const f = $('profPhotoFile').files?.[0];
      if(!f) return alert('Choose an image first.');
      try{
        // Store under profilePhotos/{uid}.{ext}
        const ext = (f.name.split('.').pop()||'jpg').toLowerCase().slice(0,5);
        const r = sRef(storage, `profilePhotos/${currentUser.uid}.${ext}`);
        await uploadBytes(r, f);
        const url = await getDownloadURL(r);
        $('profPhoto').value = url;
        await saveMyProfile(currentUser.uid);
        toastMsg('Photo uploaded');
      }catch(e){ alert('Upload failed: '+e.message); }
    };

    /* Auth */
    $('btnSignIn').onclick=async()=>{ try{ await signInWithEmailAndPassword(auth,emailEl.value,passEl.value);}catch(e){ alert(e.message); } };
    $('btnSignUp').onclick =async()=>{ try{ await createUserWithEmailAndPassword(auth,emailEl.value,passEl.value);}catch(e){ alert(e.message); } };
    btnSignOut.onclick=async()=>{ await signOut(auth); };

    async function startData(){ await watchUsers(); scopeFilter.classList.toggle('hidden', !isMod); scopeFilter.value='mine'; await watchTasks(); }

    onAuthStateChanged(auth, async (user)=>{
      currentUser=user||null;
      if(user){
        btnSignOut.classList.remove('hidden');
        authStatus.textContent=`Signed in`;
        await ensureUserProfile(user); await loadMyProfile(user.uid);
        isMod = await isModerator(user.uid);
        modHint.classList.toggle('hidden', isMod);
        startData(); go('#/tasks');
      }else{
        btnSignOut.classList.add('hidden');
        authStatus.textContent='Not signed in';
        if (unsubTasks){unsubTasks();unsubTasks=null;} if (unsubUsers){unsubUsers();unsubUsers=null;}
        allTasks=[]; taskTbody.innerHTML=''; go('#/auth');
      }
    });

    window.addEventListener('load', ()=> go(location.hash || '#/auth'));
  </script>
</body>
</html>